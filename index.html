<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>ROCKMAN vs AIRMAN</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#000;touch-action:none;-webkit-user-select:none;user-select:none}
canvas{display:block}

/* ÂõûËª¢Ë≠¶Âëä */
#rotateWarning{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:#000;z-index:9999;display:flex;flex-direction:column;
  align-items:center;justify-content:center;color:#fff;font-family:'Courier New',monospace;
}
#rotateWarning .icon{font-size:60px;animation:rotate 1.5s ease-in-out infinite}
#rotateWarning p{margin-top:20px;font-size:18px;text-align:center}
@keyframes rotate{0%,100%{transform:rotate(0deg)}50%{transform:rotate(90deg)}}
@media (orientation:landscape){#rotateWarning{display:none !important}}

#ui{position:fixed;bottom:0;left:0;right:0;display:flex;justify-content:space-between;padding:10px;pointer-events:none;z-index:10}
.cg{display:flex;gap:8px;pointer-events:auto;align-items:flex-end}

/* 3D„Çπ„ÉÜ„Ç£„ÉÉ„ÇØ */
#stickArea{
  width:140px;height:140px;position:relative;
  background:radial-gradient(circle,rgba(40,60,100,.6) 0%,rgba(20,30,50,.8) 100%);
  border-radius:50%;border:3px solid rgba(100,150,255,.4);
  box-shadow:inset 0 0 30px rgba(0,0,0,.5),0 0 15px rgba(100,150,255,.3);
}
#stickKnob{
  width:60px;height:60px;position:absolute;
  left:50%;top:50%;transform:translate(-50%,-50%);
  background:radial-gradient(circle at 35% 35%,rgba(150,200,255,.9),rgba(60,100,180,.8));
  border-radius:50%;border:2px solid rgba(200,220,255,.6);
  box-shadow:0 4px 15px rgba(0,0,0,.4),inset 0 -3px 10px rgba(0,0,0,.3);
  transition:transform 0.05s;
}
#stickKnob.active{
  background:radial-gradient(circle at 35% 35%,rgba(180,220,255,1),rgba(80,130,220,.9));
  box-shadow:0 4px 20px rgba(100,150,255,.5),inset 0 -3px 10px rgba(0,0,0,.3);
}

/* „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ */
.actBtns{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
.actRow{display:flex;gap:8px}
.b{border-radius:50%;border:3px solid rgba(255,255,255,.4);color:#fff;font-weight:bold;
display:flex;align-items:center;justify-content:center;cursor:pointer;-webkit-tap-highlight-color:transparent;
text-shadow:0 0 6px #fff;font-family:sans-serif;
box-shadow:0 4px 15px rgba(0,0,0,.4),inset 0 -3px 10px rgba(0,0,0,.2)}
.b:active{transform:scale(.92);filter:brightness(1.3)}
.bj{width:75px;height:75px;font-size:13px;background:radial-gradient(circle at 35% 35%,rgba(255,220,80,.8),rgba(220,160,30,.7))}
.bs{width:75px;height:75px;font-size:13px;background:radial-gradient(circle at 35% 35%,rgba(255,120,120,.8),rgba(220,60,60,.7))}
.bsl{width:65px;height:65px;font-size:11px;background:radial-gradient(circle at 35% 35%,rgba(120,255,200,.7),rgba(40,180,120,.6))}

#overlay{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;
align-items:center;justify-content:center;z-index:100;font-family:'Courier New',monospace;
background:rgba(0,0,0,.92)}
#overlay h1{font-size:clamp(20px,5vw,34px);margin-bottom:12px;letter-spacing:2px}
#overlay p{color:#aaa;margin-bottom:16px;font-size:13px;text-align:center;line-height:1.6}
.sbtn{padding:14px 40px;font-size:17px;background:linear-gradient(135deg,#2266cc,#4488ff);
color:#fff;border:none;border-radius:10px;cursor:pointer;font-family:inherit;
box-shadow:0 0 20px rgba(68,136,255,.4);letter-spacing:1px;margin:4px}
.sbtn:hover{background:linear-gradient(135deg,#3377dd,#55aaff)}
#hud{position:fixed;top:6px;left:6px;z-index:10;display:flex;gap:12px;align-items:flex-start}
.hbar{display:flex;flex-direction:column;gap:1px}
.hlab{color:#fff;font:bold 9px 'Courier New',monospace;text-shadow:0 1px 3px #000}
.hcon{width:100px;height:9px;background:#222;border:1px solid #555;border-radius:3px;overflow:hidden}
.hfill{height:100%;border-radius:2px;transition:width .15s}
#scoreDisp{position:fixed;top:6px;right:6px;color:#ff0;font:bold 11px 'Courier New',monospace;z-index:10;text-shadow:0 1px 3px #000}
#lifeDisp{position:fixed;top:22px;right:6px;color:#4f4;font:bold 11px 'Courier New',monospace;z-index:10;text-shadow:0 1px 3px #000}
#weaponDisp{position:fixed;top:38px;right:6px;color:#8cf;font:bold 10px 'Courier New',monospace;z-index:10;text-shadow:0 1px 3px #000}
</style>
</head>
<body>
<!-- ÂõûËª¢Ë≠¶Âëä -->
<div id="rotateWarning">
  <div class="icon">üì±</div>
  <p>„Çπ„Éû„Éº„Éà„Éï„Ç©„É≥„Çí<br>Ê®™Âêë„Åç„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
</div>

<div id="overlay">
<h1 style="color:#4af;text-shadow:0 0 30px #4af,0 0 60px #28f">‚ö° ROCKMAN ‚ö°</h1>
<h1 style="color:#f84;text-shadow:0 0 20px #f84;font-size:clamp(16px,4vw,28px)">vs AIR MAN</h1>
<p>‚Äî SKY FORTRESS STAGE ‚Äî<br><br>
üéÆ ÁßªÂãïÔºö„Çπ„ÉÜ„Ç£„ÉÉ„ÇØ / „Ç∏„É£„É≥„ÉóÔºöJUMP<br>
üî´ „Ç∑„Éß„ÉÉ„ÉàÔºöSHOT / „Çπ„É©„Ç§„Éá„Ç£„É≥„Ç∞ÔºöSLIDE</p>
<button class="sbtn" id="startBtn">READY</button>
</div>
<div id="hud">
<div class="hbar"><span class="hlab">‚òÖ ROCK</span><div class="hcon"><div class="hfill" id="php" style="width:100%;background:linear-gradient(90deg,#4f4,#8f8)"></div></div></div>
<div class="hbar" id="bhud" style="display:none"><span class="hlab">‚ò† AIRMAN</span><div class="hcon"><div class="hfill" id="bhp" style="width:100%;background:linear-gradient(90deg,#f44,#f88)"></div></div></div>
</div>
<div id="scoreDisp">SCORE: 0</div>
<div id="lifeDisp">LIFE: ‚òÖ‚òÖ‚òÖ</div>
<div id="weaponDisp">WEAPON: P.BUSTER</div>
<canvas id="c"></canvas>
<div id="ui">
<div class="cg">
  <div id="stickArea">
    <div id="stickKnob"></div>
  </div>
</div>
<div class="cg">
  <div class="actBtns">
    <div class="actRow">
      <button class="b bs" id="bS">SHOT</button>
      <button class="b bj" id="bJ">JUMP</button>
    </div>
    <button class="b bsl" id="bSL">SLIDE</button>
  </div>
</div>
</div>
<script>
// Ê®™Âêë„ÅçÂº∑Âà∂
function lockOrientation(){
  if(screen.orientation&&screen.orientation.lock){
    screen.orientation.lock('landscape').catch(()=>{});
  }
}

const C=document.getElementById('c'),X=C.getContext('2d');
let W,H;function resize(){W=C.width=innerWidth;H=C.height=innerHeight}
resize();addEventListener('resize',resize);

let started=0,over=0,clear=0,paused=0,frame=0;
let score=0,lives=3,checkpoint=0;
let doorState=0;
let doorAnimTimer=0;
let bossRoomCamLocked=0;

const K={l:0,r:0,u:0,j:0,s:0,sl:0};let sPress=0,slPress=0;

// 3D„Çπ„ÉÜ„Ç£„ÉÉ„ÇØ
const stickArea=document.getElementById('stickArea');
const stickKnob=document.getElementById('stickKnob');
let stickActive=false;
let stickCenter={x:0,y:0};
let stickPos={x:0,y:0};
const STICK_MAX=45;

function getStickCenter(){
  const rect=stickArea.getBoundingClientRect();
  return{x:rect.left+rect.width/2,y:rect.top+rect.height/2};
}

function updateStick(clientX,clientY){
  const center=getStickCenter();
  let dx=clientX-center.x;
  let dy=clientY-center.y;
  const dist=Math.sqrt(dx*dx+dy*dy);
  if(dist>STICK_MAX){dx=dx/dist*STICK_MAX;dy=dy/dist*STICK_MAX}
  stickPos={x:dx,y:dy};
  stickKnob.style.transform=`translate(calc(-50% + ${dx}px),calc(-50% + ${dy}px))`;
  
  // ÂÖ•ÂäõÂ§âÊèõ
  const threshold=15;
  K.l=dx<-threshold?1:0;
  K.r=dx>threshold?1:0;
  K.u=dy<-threshold?1:0;
}

function resetStick(){
  stickPos={x:0,y:0};
  stickKnob.style.transform='translate(-50%,-50%)';
  stickKnob.classList.remove('active');
  K.l=0;K.r=0;K.u=0;
}

stickArea.addEventListener('touchstart',e=>{
  e.preventDefault();
  stickActive=true;
  stickKnob.classList.add('active');
  const t=e.touches[0];
  updateStick(t.clientX,t.clientY);
});
stickArea.addEventListener('touchmove',e=>{
  e.preventDefault();
  if(!stickActive)return;
  const t=e.touches[0];
  updateStick(t.clientX,t.clientY);
});
stickArea.addEventListener('touchend',e=>{
  e.preventDefault();
  stickActive=false;
  resetStick();
});
stickArea.addEventListener('touchcancel',e=>{
  stickActive=false;
  resetStick();
});

// „Éû„Ç¶„ÇπÂØæÂøúÔºàPCÔºâ
stickArea.addEventListener('mousedown',e=>{
  e.preventDefault();
  stickActive=true;
  stickKnob.classList.add('active');
  updateStick(e.clientX,e.clientY);
});
document.addEventListener('mousemove',e=>{
  if(!stickActive)return;
  updateStick(e.clientX,e.clientY);
});
document.addEventListener('mouseup',e=>{
  if(stickActive){stickActive=false;resetStick()}
});

// „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥
function bindBtn(id,k,isPress){
  const e=document.getElementById(id);
  ['touchstart','mousedown'].forEach(v=>e.addEventListener(v,ev=>{
    ev.preventDefault();K[k]=1;if(isPress){if(k==='s')sPress=1;if(k==='sl')slPress=1}
  }));
  ['touchend','mouseup','touchcancel'].forEach(v=>e.addEventListener(v,ev=>{ev.preventDefault();K[k]=0}));
}
bindBtn('bJ','j',false);
bindBtn('bS','s',true);
bindBtn('bSL','sl',true);

addEventListener('keydown',e=>{
if(e.key==='ArrowLeft'||e.key==='a')K.l=1;
if(e.key==='ArrowRight'||e.key==='d')K.r=1;
if(e.key==='ArrowUp'||e.key==='w')K.u=1;
if(e.key==='ArrowDown')K.sl=1;
if(e.key===' ')K.j=1;
if(e.key==='z'||e.key==='j'){K.s=1;sPress=1}
if(e.key==='x'||e.key==='c'){K.sl=1;slPress=1}
if(e.key==='Escape')paused=!paused;
});
addEventListener('keyup',e=>{
if(e.key==='ArrowLeft'||e.key==='a')K.l=0;
if(e.key==='ArrowRight'||e.key==='d')K.r=0;
if(e.key==='ArrowUp'||e.key==='w')K.u=0;
if(e.key==='ArrowDown')K.sl=0;
if(e.key===' ')K.j=0;
if(e.key==='z'||e.key==='j')K.s=0;
if(e.key==='x'||e.key==='c')K.sl=0;
});

const T=32,G=0.55,SPD=3.8,JF=-11.5,BSPD=9,SW=280,SH=20;

const DOOR_X = 222;
const BOSS_ROOM_START = 223;
const BOSS_ROOM_WIDTH = 18; // „Éú„ÇπÈÉ®Â±ã„ÅÆÂπÖÔºà„Çø„Ç§„É´Êï∞Ôºâ

let items=[];
let map=[];

function genStage(){
map=[];for(let x=0;x<SW;x++){let c=[];for(let y=0;y<SH;y++)c.push(0);map.push(c)}
let gy;
for(let x=0;x<SW;x++){
  gy=16;
  if(x<55){
    gy=16+Math.round(Math.sin(x*.06)*1);
    if((x>18&&x<22)||(x>35&&x<39)||(x>48&&x<52))gy=99;
  }else if(x<110){
    gy=15;
    if((x>62&&x<66)||(x>78&&x<82)||(x>95&&x<99))gy=99;
    for(let y=0;y<3;y++)map[x][y]=12;
  }else if(x<170){
    gy=15;
    if((x>118&&x<122)||(x>138&&x<142)||(x>155&&x<159))gy=99;
    for(let y=0;y<2;y++)map[x][y]=13;
  }else if(x<220){
    gy=16;
    if((x>178&&x<182)||(x>195&&x<199)||(x>210&&x<214))gy=99;
  }else{
    gy=16;
  }
  if(gy<99)for(let y=gy;y<SH;y++)map[x][y]=(x<55)?1:(x<110)?14:(x<170)?15:16;
}

const pl=[
[5,14],[6,14],[7,14],
[10,12],[11,12],[12,12],[13,12],
[16,10],[17,10],[18,10],
[19,13],[20,13],[21,13],[22,13],
[25,11],[26,11],[27,11],
[30,9],[31,9],[32,9],
[34,12],[35,12],
[36,14],[37,14],[38,14],[39,14],
[42,11],[43,11],[44,11],
[47,9],[48,9],
[49,12],[50,12],[51,12],[52,12],
[56,13],[57,13],[58,13],
[60,11],[61,11],[62,11],
[63,9],[64,9],[65,9],[66,9],
[68,13],[69,13],
[71,11],[72,11],[73,11],
[75,8],[76,8],[77,8],
[79,12],[80,12],[81,12],[82,12],
[84,10],[85,10],
[87,13],[88,13],[89,13],
[91,8],[92,8],[93,8],
[96,11],[97,11],[98,11],[99,11],
[101,9],[102,9],
[105,13],[106,13],[107,13],
[112,13],[113,13],[114,13],
[116,11],[117,11],[118,11],
[119,9],[120,9],[121,9],[122,9],
[124,13],[125,13],
[127,11],[128,11],[129,11],
[131,8],[132,8],[133,8],
[135,12],[136,12],[137,12],
[139,10],[140,10],[141,10],[142,10],
[144,13],[145,13],
[147,8],[148,8],[149,8],
[151,11],[152,11],
[154,13],[155,13],[156,13],
[158,9],[159,9],[160,9],
[162,12],[163,12],[164,12],
[166,10],[167,10],
[172,14],[173,14],[174,14],
[176,12],[177,12],[178,12],
[179,10],[180,10],[181,10],[182,10],
[184,13],[185,13],
[187,11],[188,11],[189,11],
[191,8],[192,8],[193,8],
[196,12],[197,12],[198,12],[199,12],
[201,10],[202,10],
[204,13],[205,13],[206,13],
[208,8],[209,8],[210,8],
[211,11],[212,11],[213,11],[214,14],
[216,13],[217,13],[218,13],
];
pl.forEach(([px,py])=>{if(px<SW&&py<SH&&map[px][py]===0)map[px][py]=2});

// „Éú„ÇπÈÉ®Â±ã„ÅÆÁ©∫‰∏≠Ë∂≥Â†¥„ÇíËøΩÂä†
const bossPlats=[
  // Â∑¶ÂÅ¥„ÅÆË∂≥Â†¥
  [226,12],[227,12],[228,12],
  // ‰∏≠Â§Æ‰∏ä„ÅÆË∂≥Â†¥
  [231,9],[232,9],[233,9],[234,9],
  // Âè≥ÂÅ¥„ÅÆË∂≥Â†¥
  [237,12],[238,12],[239,12],
  // ‰∏≠Â§Æ‰∏ã„ÅÆË∂≥Â†¥
  [230,14],[231,14],[232,14],
  [234,14],[235,14],[236,14],
  // È´ò„ÅÑ‰ΩçÁΩÆ„ÅÆÂ∞è„Åï„Å™Ë∂≥Â†¥
  [228,7],[229,7],
  [236,7],[237,7],
];
bossPlats.forEach(([px,py])=>{if(px<SW&&py<SH)map[px][py]=2});

[15,28,45,60,73,90,104,117,133,148,165,177,193,209].forEach(lx=>{
  if(lx<SW)for(let y=7;y<15;y++)if(map[lx][y]===0)map[lx][y]=9;
});

[14,33,47,70,86,100,126,143,160,185,200,215].forEach(sx=>{
  if(sx<SW){let gy2=SH-1;for(let y=0;y<SH;y++)if(map[sx][y]>=1&&map[sx][y]<=16&&map[sx][y]!==9){gy2=y;break}
  if(gy2>0&&map[sx][gy2-1]===0)map[sx][gy2-1]=3}
});

[65,66,80,81,96,97].forEach(wx=>{if(wx<SW)for(let y=5;y<8;y++)if(map[wx][y]===0)map[wx][y]=17;});

[55,110,170].forEach(cx=>{if(cx<SW)map[cx][15]=18});

// „Éú„ÇπÊââ
for(let y=10;y<16;y++){
  map[DOOR_X][y]=11;
}

[[12,11,'eSmall'],[40,13,'eSmall'],[67,8,'eLarge'],[93,7,'eLarge'],
[120,8,'eSmall'],[149,7,'eLarge'],[190,7,'eLarge'],[205,12,'life']].forEach(([ix,iy,it])=>{
  items.push({x:ix*T+8,y:iy*T+8,w:16,h:16,type:it,alive:1,bobOff:Math.random()*6.28});
});
}
genStage();

let P={x:60,y:420,w:22,h:30,vx:0,vy:0,og:0,face:1,hp:28,mhp:28,st:0,inv:0,dead:0,
climbing:0,sliding:0,slideTimer:0,chargeTimer:0,charged:0,runFrame:0,teleportIn:60,
wallJumpTimer:0,dashTrail:[]};

let pBul=[],eBul=[];

let enemies=[];
function spawnEnemies(){
enemies=[];
const defs=[
{x:180,t:'fly'},{x:350,t:'goblin'},{x:500,t:'fly'},{x:700,t:'cannon'},
{x:900,t:'goblin'},{x:1100,t:'fly'},{x:1300,t:'shield'},{x:1450,t:'goblin'},
{x:1600,t:'fly'},{x:1800,t:'cannon'},{x:2000,t:'goblin'},{x:2200,t:'fly'},
{x:2400,t:'shield'},{x:2600,t:'cannon'},{x:2800,t:'goblin'},{x:3000,t:'fly'},
{x:3200,t:'shield'},{x:3400,t:'cannon'},{x:3600,t:'goblin'},{x:3800,t:'fly'},
{x:4000,t:'cannon'},{x:4200,t:'shield'},{x:4400,t:'goblin'},{x:4600,t:'fly'},
{x:4800,t:'cannon'},{x:5000,t:'goblin'},{x:5200,t:'shield'},{x:5400,t:'fly'},
{x:5600,t:'cannon'},{x:5800,t:'goblin'},{x:6000,t:'fly'},{x:6200,t:'shield'},
{x:6400,t:'cannon'},{x:6600,t:'goblin'},{x:6800,t:'fly'},
];
defs.forEach(d=>{
  let tx=Math.floor(d.x/T),gy2=15;
  if(tx<SW){
    for(let y=0;y<SH;y++){
      let t=map[tx][y];
      if(t===1||t===2||t===14||t===15||t===16){gy2=y;break}
    }
  }
  let ey=d.t==='fly'?gy2*T-70:gy2*T-28;
  enemies.push({x:d.x,y:ey,w:24,h:28,vx:0,vy:0,type:d.t,hp:d.t==='cannon'?4:d.t==='shield'?3:2,
    alive:1,og:0,dir:-1,timer:Math.random()*100|0,st:0,shielded:0,baseY:ey,angle:0,flash:0});
});
}
spawnEnemies();

// „Éú„ÇπHP 1.2ÂÄç: 28 * 1.2 = 33.6 ‚Üí 34
let boss={x:7600,y:400,w:48,h:56,vx:0,vy:0,hp:34,mhp:34,alive:1,active:0,og:0,
dir:-1,timer:0,inv:0,at:0,pat:0,phase:0,flash:0,
fanAngle:0,tornadoTimer:0,introTimer:0,defeated:0,defeatTimer:0};

let parts=[];
let floatTexts=[];
let screenFlash=0;
let screenFadeIn=60;
let bossIntro=0;
let windParticles=[];

function boom(x,y,col,n){n=n||14;for(let i=0;i<n;i++)parts.push({x,y,
vx:(Math.random()-.5)*8,vy:(Math.random()-.5)*8-2,
life:18+Math.random()*20,col:col||'#ff0',sz:1.5+Math.random()*4,type:0})}
function sparkle(x,y,col){parts.push({x,y,vx:(Math.random()-.5)*2,vy:-Math.random()*2-1,
life:30+Math.random()*25,col:col||'#fff',sz:1+Math.random()*2,type:1})}
function addFloatText(x,y,text,col){floatTexts.push({x,y,text,col:col||'#fff',life:50,vy:-1.5})}

let camX=0,camY=0,camShake=0;
let zoneLabel='',zoneLT=0;

function tileAt(px,py){let tx=Math.floor(px/T),ty=Math.floor(py/T);
if(tx<0||tx>=SW||ty<0||ty>=SH)return 0;return map[tx][ty]}

function solid(px,py){
  let t=tileAt(px,py);
  let tx=Math.floor(px/T);
  if(t===11 && tx===DOOR_X && doorState===1) return false;
  return(t>=1&&t<=2)||(t>=11&&t<=16);
}

function isLad(px,py){return tileAt(px,py)===9}
function isWind(px,py){return tileAt(px,py)===17}

function moveEnt(e){
  e.x+=e.vx;
  if(e.vx>0){if(solid(e.x+e.w,e.y+3)||solid(e.x+e.w,e.y+e.h-3)){e.x=Math.floor((e.x+e.w)/T)*T-e.w-.01;e.vx=0}}
  else if(e.vx<0){if(solid(e.x,e.y+3)||solid(e.x,e.y+e.h-3)){e.x=Math.ceil(e.x/T)*T+.01;e.vx=0}}
  if(!e.climbing){e.vy+=G;if(e.vy>13)e.vy=13}
  e.y+=e.vy;e.og=0;
  if(e.vy>=0){if(solid(e.x+3,e.y+e.h)||solid(e.x+e.w-3,e.y+e.h)){
    e.y=Math.floor((e.y+e.h)/T)*T-e.h;e.vy=0;e.og=1}}
  else{if(solid(e.x+3,e.y)||solid(e.x+e.w-3,e.y)){e.y=Math.ceil(e.y/T)*T;e.vy=0}}
  if(isWind(e.x+e.w/2,e.y+e.h/2)){e.vy-=.8;if(e.vy<-4)e.vy=-4}
  return e.y>SH*T+150;
}
function rCol(a,b){return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y}

function drawBG(){
  let zone=getZone(camX+W/2);
  let g=X.createLinearGradient(0,0,0,H);
  if(zone===0){g.addColorStop(0,'#0a2a5a');g.addColorStop(.5,'#1a4a8a');g.addColorStop(1,'#3a6aaa')}
  else if(zone===1){g.addColorStop(0,'#0a1a3a');g.addColorStop(.5,'#1a3060');g.addColorStop(1,'#2a4a80')}
  else if(zone===2){g.addColorStop(0,'#1a1a3a');g.addColorStop(.5,'#2a2a5a');g.addColorStop(1,'#3a3a7a')}
  else if(zone===3){g.addColorStop(0,'#1a0a2a');g.addColorStop(.5,'#2a1a4a');g.addColorStop(1,'#3a2a6a')}
  else{g.addColorStop(0,'#2a0a0a');g.addColorStop(.5,'#3a1515');g.addColorStop(1,'#4a2020')}
  X.fillStyle=g;X.fillRect(0,0,W,H);

  for(let i=0;i<20;i++){
    let cx=((i*197+50)%1200)-(camX*.08%1200)+(frame*.15);if(cx>1200)cx-=1200;if(cx<-200)cx+=1200;
    let cy=40+(i*83%180);
    let cw=60+(i*31%80);
    X.fillStyle=`rgba(255,255,255,${.04+Math.sin(i)*.02})`;
    X.beginPath();X.ellipse(cx,cy,cw,15+i%10,0,0,Math.PI*2);X.fill();
  }
  for(let i=0;i<12;i++){
    let bx=i*160-(camX*.12%(12*160));if(bx<-160)bx+=12*160;
    let bh=50+(i*53%90);
    X.fillStyle=`rgba(20,30,60,${.4})`;
    X.fillRect(bx,H-bh-30,100,bh+30);
    for(let wy=10;wy<bh;wy+=14)for(let wx=8;wx<90;wx+=18)
      if((i+wy+wx)%4===0){X.fillStyle='rgba(255,220,100,.15)';X.fillRect(bx+wx,H-bh-30+wy,5,5);X.fillStyle=`rgba(20,30,60,.4)`}
  }
  if(getZone(P.x)===1){
    for(let i=0;i<8;i++){
      let wx=(frame*3+i*120)%W;
      let wy=(i*67)%H;
      X.strokeStyle=`rgba(200,230,255,${.15+Math.sin(frame*.05+i)*.1})`;
      X.lineWidth=1;X.beginPath();X.moveTo(wx,wy);X.lineTo(wx+40+Math.sin(frame*.1+i)*10,wy+5);X.stroke();
    }
  }
}

function getZone(px){let tx=px/T;if(tx<55)return 0;if(tx<110)return 1;if(tx<170)return 2;if(tx<220)return 3;return 4}

function drawTile(tx,ty,t,sx,sy){
  if(t===0)return;
  let zone=getZone(tx*T);
  let above=ty>0?map[tx][ty-1]:99;
  let isTop=above===0||above===9||above===17||above===3||above===18||above===11;

  if(t===1||t===14||t===15||t===16){
    let cols;
    if(t===1)cols=isTop?['#5a8a4a','#4a7a3a']:['#3a5a2a','#2a4a1a'];
    else if(t===14)cols=isTop?['#6a7a8a','#5a6a7a']:['#4a5a6a','#3a4a5a'];
    else if(t===15)cols=isTop?['#7a7aaa','#6a6a9a']:['#4a4a7a','#3a3a6a'];
    else cols=isTop?['#6a5a8a','#5a4a7a']:['#4a3a6a','#3a2a5a'];
    X.fillStyle=cols[0];X.fillRect(sx,sy,T,T);
    if(isTop){X.fillStyle=cols[1];X.fillRect(sx,sy,T,4);
      X.fillStyle='rgba(255,255,255,.08)';X.fillRect(sx,sy,T,2)}
    X.fillStyle='rgba(0,0,0,.08)';X.fillRect(sx+(tx*7%12),sy+(ty*5%10),8,5);
    X.strokeStyle='rgba(0,0,0,.1)';X.strokeRect(sx,sy,T,T);
  }else if(t===2){
    // „Éú„ÇπÈÉ®Â±ã„ÅÆË∂≥Â†¥„ÅØÁâπÂà•„Å™Ëâ≤
    let inBossRoom=tx>=BOSS_ROOM_START;
    let c;
    if(inBossRoom){
      c=['#8a5a6a','#9a6a7a'];
    }else{
      c=zone===0?['#5a9a5a','#6aaa6a']:zone===1?['#6a8a9a','#7a9aaa']:zone===2?['#7a6aaa','#8a7abb']:['#6a5a9a','#7a6aaa'];
    }
    X.fillStyle=c[0];X.fillRect(sx,sy,T,T);X.fillStyle=c[1];X.fillRect(sx,sy,T,5);
    X.fillStyle='rgba(255,255,255,.1)';X.fillRect(sx+2,sy+1,T-4,2);
    X.strokeStyle='rgba(0,0,0,.12)';X.strokeRect(sx,sy,T,T);
  }else if(t===3){
    for(let i=0;i<4;i++){
      X.fillStyle='#cc2222';X.beginPath();X.moveTo(sx+i*8,sy+T);X.lineTo(sx+i*8+4,sy+4);X.lineTo(sx+i*8+8,sy+T);X.fill();
      X.fillStyle='#ff5555';X.beginPath();X.moveTo(sx+i*8+1,sy+T);X.lineTo(sx+i*8+4,sy+8);X.lineTo(sx+i*8+7,sy+T);X.fill();
    }
  }else if(t===9){
    X.fillStyle='#8a7a5a';X.fillRect(sx+5,sy,4,T);X.fillRect(sx+T-9,sy,4,T);
    X.fillStyle='#9a8a6a';for(let r=3;r<T;r+=8)X.fillRect(sx+5,sy+r,T-10,3);
  }else if(t===11){
    if(doorState===1){
      let openAmt=Math.min(1,doorAnimTimer/20);
      let doorH=T*(1-openAmt);
      if(doorH>2){
        X.fillStyle='#8a6600';X.fillRect(sx,sy,T,doorH);
        X.fillStyle=`rgba(255,200,0,${.5+Math.sin(frame*.08)*.2})`;X.fillRect(sx+3,sy+2,T-6,doorH-4);
      }
    }else if(doorState===2){
      X.fillStyle='#6a4400';X.fillRect(sx,sy,T,T);
      X.fillStyle=`rgba(200,100,0,${.5})`;X.fillRect(sx+3,sy+2,T-6,T-4);
      X.fillStyle='#442200';X.fillRect(sx+T/2-4,sy+T/2-5,8,10);
      X.strokeStyle='#ff0000';X.lineWidth=2;
      X.beginPath();X.moveTo(sx+8,sy+8);X.lineTo(sx+T-8,sy+T-8);X.stroke();
      X.beginPath();X.moveTo(sx+T-8,sy+8);X.lineTo(sx+8,sy+T-8);X.stroke();
    }else{
      let pulse=.5+Math.sin(frame*.08)*.2;
      X.fillStyle='#8a6600';X.fillRect(sx,sy,T,T);
      X.fillStyle=`rgba(255,200,0,${pulse})`;X.fillRect(sx+3,sy+2,T-6,T-4);
      X.fillStyle='#664400';X.fillRect(sx+T/2-4,sy+T/2-5,8,10);
    }
  }else if(t===12||t===13){
    X.fillStyle=t===12?'#3a4a5a':'#4a4a6a';X.fillRect(sx,sy,T,T);
    let below=ty<SH-1?map[tx][ty+1]:0;
    if(below===0||below===9||below===17){
      X.fillStyle=t===12?'#4a5a6a':'#5a5a7a';X.fillRect(sx,sy+T-3,T,3);
      if((tx+ty)%3===0){X.fillStyle=t===12?'#5a6a7a':'#6a6a8a';
        X.beginPath();X.moveTo(sx+4,sy+T);X.lineTo(sx+T/2,sy+T+6);X.lineTo(sx+T-4,sy+T);X.fill()}
    }
  }else if(t===17){
    let a=.1+Math.sin(frame*.06+tx)*.05;
    X.fillStyle=`rgba(150,200,255,${a})`;X.fillRect(sx,sy,T,T);
    X.strokeStyle=`rgba(200,230,255,${.2+Math.sin(frame*.1+tx)*.1})`;X.lineWidth=1;
    let ay=sy+T/2+Math.sin(frame*.15+tx)*5;
    X.beginPath();X.moveTo(sx+6,ay+4);X.lineTo(sx+T/2,ay-4);X.lineTo(sx+T-6,ay+4);X.stroke();
  }else if(t===18){
    let lit=P.x/T>tx;
    X.fillStyle='#666';X.fillRect(sx+12,sy,8,T);
    X.fillStyle=lit?'#4f4':'#a44';X.beginPath();X.arc(sx+16,sy,8,0,Math.PI*2);X.fill();
    if(lit){X.fillStyle=`rgba(100,255,100,${.2+Math.sin(frame*.1)*.1})`;X.beginPath();X.arc(sx+16,sy,12,0,Math.PI*2);X.fill()}
  }
}

function drawTiles(){
  let stx=Math.floor(camX/T)-1,etx=Math.ceil((camX+W)/T)+1;
  let sty=Math.floor(camY/T)-1,ety=Math.ceil((camY+H)/T)+1;
  for(let tx=stx;tx<=etx;tx++)for(let ty=sty;ty<=ety;ty++){
    if(tx<0||tx>=SW||ty<0||ty>=SH)continue;
    drawTile(tx,ty,map[tx][ty],tx*T-camX,ty*T-camY);
  }
}

function drawItems(){
  items.forEach(it=>{
    if(!it.alive)return;
    let ix=it.x-camX,iy=it.y-camY+Math.sin(frame*.06+it.bobOff)*3;
    if(ix<-30||ix>W+30)return;
    if(it.type==='eSmall'){
      X.fillStyle='#44aaff';X.beginPath();X.arc(ix+8,iy+8,6,0,Math.PI*2);X.fill();
      X.fillStyle='#88ddff';X.beginPath();X.arc(ix+7,iy+6,2.5,0,Math.PI*2);X.fill();
      X.fillStyle=`rgba(68,170,255,${.2+Math.sin(frame*.1+it.bobOff)*.1})`;X.beginPath();X.arc(ix+8,iy+8,10,0,Math.PI*2);X.fill();
    }else if(it.type==='eLarge'){
      X.fillStyle='#ff8844';X.beginPath();X.arc(ix+8,iy+8,8,0,Math.PI*2);X.fill();
      X.fillStyle='#ffbb88';X.beginPath();X.arc(ix+6,iy+6,3,0,Math.PI*2);X.fill();
      X.fillStyle=`rgba(255,136,68,${.2+Math.sin(frame*.1+it.bobOff)*.1})`;X.beginPath();X.arc(ix+8,iy+8,12,0,Math.PI*2);X.fill();
    }else if(it.type==='life'){
      X.fillStyle='#ff4444';
      X.beginPath();let cx2=ix+8,cy2=iy+8;
      X.moveTo(cx2,cy2+3);X.bezierCurveTo(cx2-6,cy2-4,cx2-6,cy2-8,cx2,cy2-4);
      X.bezierCurveTo(cx2+6,cy2-8,cx2+6,cy2-4,cx2,cy2+3);X.fill();
      X.fillStyle=`rgba(255,68,68,${.2+Math.sin(frame*.1)*.1})`;X.beginPath();X.arc(cx2,cy2,12,0,Math.PI*2);X.fill();
    }
  });
}

function drawPlayer(){
  if(P.dead)return;
  if(P.teleportIn>0){
    let ty2=P.y-camY-(P.teleportIn/60)*H;
    X.fillStyle='#4488ff';X.fillRect(P.x-camX+8,ty2,6,P.teleportIn*3);
    for(let i=0;i<3;i++)sparkle(P.x+11+Math.random()*4-2,P.y-P.teleportIn*5+Math.random()*30,'#88ccff');
    return;
  }
  if(P.inv>0&&Math.floor(P.inv/2)%2)return;
  let px=P.x-camX,py=P.y-camY,f=P.face;

  if(P.sliding){
    P.dashTrail.push({x:P.x,y:P.y,a:.3});
    if(P.dashTrail.length>6)P.dashTrail.shift();
    P.dashTrail.forEach((dt,i)=>{
      X.globalAlpha=dt.a*(i/P.dashTrail.length);
      X.fillStyle='#4488ff';X.fillRect(dt.x-camX+2,dt.y-camY+18,18,12);
      X.globalAlpha=1;dt.a*=.85;
    });
  }else P.dashTrail=[];

  X.save();X.translate(px+P.w/2,py+P.h/2);if(f<0)X.scale(-1,1);
  let ox=-P.w/2,oy=-P.h/2;

  if(P.sliding){
    let bG=X.createLinearGradient(0,oy+16,0,oy+30);
    bG.addColorStop(0,'#3388ff');bG.addColorStop(1,'#2266dd');
    X.fillStyle=bG;X.beginPath();X.roundRect(ox-4,oy+18,28,12,4);X.fill();
    X.fillStyle='#3388ff';X.beginPath();X.arc(ox+2,oy+20,10,0,Math.PI*2);X.fill();
    X.fillStyle='#55aaff';X.beginPath();X.arc(ox+2,oy+17,3,0,Math.PI*2);X.fill();
    X.fillStyle='#ffe0b0';X.beginPath();X.roundRect(ox+4,oy+19,8,7,2);X.fill();
    X.fillStyle='#224';X.fillRect(ox+9,oy+21,2,2);
    X.restore();return;
  }

  X.fillStyle='rgba(0,0,0,.15)';X.beginPath();X.ellipse(0,P.h/2+2,10,3,0,0,Math.PI*2);X.fill();

  let la=P.og&&Math.abs(P.vx)>.5?Math.sin(P.runFrame)*5:0;
  X.fillStyle='#1a55bb';
  X.fillRect(ox+3,oy+22,8,10+la);X.fillRect(ox+11,oy+22,8,10-la);
  X.fillStyle='#1144aa';
  X.beginPath();X.roundRect(ox+2,oy+28+Math.max(0,la),9,5,2);X.fill();
  X.beginPath();X.roundRect(ox+11,oy+28-Math.min(0,la),9,5,2);X.fill();

  let bodyG=X.createLinearGradient(0,oy+8,0,oy+24);
  bodyG.addColorStop(0,'#3388ff');bodyG.addColorStop(1,'#2266dd');
  X.fillStyle=bodyG;X.beginPath();X.roundRect(ox+2,oy+10,18,14,3);X.fill();
  X.fillStyle='rgba(255,255,255,.1)';X.fillRect(ox+4,oy+11,6,4);

  if(P.chargeTimer>30){
    let ca=.2+Math.sin(frame*.3)*.15;
    let cc=P.chargeTimer>60?'rgba(0,255,200,':'rgba(100,200,255,';
    X.fillStyle=cc+ca+')';X.beginPath();X.arc(0,0,14+Math.sin(frame*.4)*3,0,Math.PI*2);X.fill();
  }

  let helG=X.createRadialGradient(0,oy+4,0,0,oy+6,13);
  helG.addColorStop(0,'#55aaff');helG.addColorStop(1,'#2266dd');
  X.fillStyle=helG;X.beginPath();X.arc(0,oy+10,12,Math.PI,0);X.fill();
  X.fillRect(ox,oy+5,P.w,6);
  X.fillStyle='#1155cc';X.beginPath();X.arc(ox+P.w+1,oy+10,4,0,Math.PI*2);X.fill();
  let gemG=X.createRadialGradient(0,oy+3,0,0,oy+3,4);
  gemG.addColorStop(0,'#aaeeff');gemG.addColorStop(1,'#44aaff');
  X.fillStyle=gemG;X.beginPath();X.arc(0,oy+3,3.5,0,Math.PI*2);X.fill();
  X.fillStyle='rgba(255,255,255,.6)';X.beginPath();X.arc(-1,oy+2,1.2,0,Math.PI*2);X.fill();

  let fG=X.createRadialGradient(ox+11,oy+14,0,ox+11,oy+14,7);
  fG.addColorStop(0,'#ffe0b0');fG.addColorStop(1,'#ddbb88');
  X.fillStyle=fG;X.beginPath();X.roundRect(ox+4,oy+10,14,11,2);X.fill();
  X.fillStyle='#224';X.beginPath();X.ellipse(ox+14,oy+14,2,2.5,0,0,Math.PI*2);X.fill();
  X.fillStyle='#fff';X.beginPath();X.arc(ox+14.5,oy+13,.8,0,Math.PI*2);X.fill();
  X.fillStyle='#cc8866';X.fillRect(ox+10,oy+18,4,1.5);

  X.fillStyle='#3388ff';
  if(P.st>0){
    X.fillRect(ox+16,oy+13,10,7);
    let bG2=X.createRadialGradient(ox+26,oy+16.5,0,ox+26,oy+16.5,5);
    bG2.addColorStop(0,'#88ccff');bG2.addColorStop(1,'#3388ff');
    X.fillStyle=bG2;X.beginPath();X.arc(ox+26,oy+16.5,5.5,0,Math.PI*2);X.fill();
    if(P.chargeTimer>30){
      X.fillStyle=`rgba(100,255,255,${.3+Math.sin(frame*.5)*.2})`;X.beginPath();X.arc(ox+26,oy+16.5,8,0,Math.PI*2);X.fill();
    }
  }else{
    X.fillRect(ox+16,oy+14,8,6);X.beginPath();X.arc(ox+24,oy+17,4,0,Math.PI*2);X.fill();
  }
  X.restore();
}

function drawEnemy(e){
  if(!e.alive)return;
  let ex=e.x-camX,ey=e.y-camY;
  if(ex<-60||ex>W+60)return;
  if(e.flash>0){X.globalAlpha=.5+Math.sin(frame)*.3;e.flash--}

  if(e.type==='goblin'){
    let bob=Math.sin(frame*.15)*2;
    X.fillStyle='#55cc55';X.beginPath();X.roundRect(ex+2,ey+2+bob,20,18,5);X.fill();
    X.fillStyle='#ff3333';X.beginPath();X.arc(ex+8,ey+10+bob,2.5,0,Math.PI*2);X.fill();
    X.beginPath();X.arc(ex+16,ey+10+bob,2.5,0,Math.PI*2);X.fill();
    X.fillStyle='#338833';let la2=Math.sin(frame*.2)*3;
    X.fillRect(ex+4,ey+20+bob,6,8+la2);X.fillRect(ex+14,ey+20+bob,6,8-la2);
  }else if(e.type==='fly'){
    let fy=e.baseY+Math.sin(frame*.05+e.x*.008)*25-camY;
    e.y=e.baseY+Math.sin(frame*.05+e.x*.008)*25;
    let wing=Math.sin(frame*.3)*8;
    X.fillStyle='rgba(100,200,255,.35)';
    X.beginPath();X.ellipse(ex+12,fy+6,14+wing,5,-.3,0,Math.PI*2);X.fill();
    X.beginPath();X.ellipse(ex+12,fy+6,14+wing,5,.3,0,Math.PI*2);X.fill();
    X.fillStyle='#4488cc';X.beginPath();X.arc(ex+12,fy+12,8,0,Math.PI*2);X.fill();
    X.fillStyle='#ff2222';X.beginPath();X.arc(ex+9,fy+10,2,0,Math.PI*2);X.fill();
    X.beginPath();X.arc(ex+15,fy+10,2,0,Math.PI*2);X.fill();
  }else if(e.type==='cannon'){
    X.fillStyle='#555';X.beginPath();X.roundRect(ex,ey+6,24,18,3);X.fill();
    X.fillStyle='#777';X.fillRect(ex+2,ey+8,20,14);
    let ang=Math.atan2(P.y-e.y,P.x-e.x);
    X.save();X.translate(ex+12,ey+15);X.rotate(ang);
    X.fillStyle='#444';X.fillRect(0,-3.5,18,7);
    X.fillStyle='#fa0';X.beginPath();X.arc(18,0,3.5,0,Math.PI*2);X.fill();
    X.restore();
    let fl=.4+Math.sin(frame*.12)*.25;
    X.fillStyle=`rgba(255,0,0,${fl})`;X.beginPath();X.arc(ex+12,ey+6,3,0,Math.PI*2);X.fill();
  }else if(e.type==='shield'){
    X.fillStyle='#228844';X.beginPath();X.roundRect(ex+2,ey+2,20,22,3);X.fill();
    X.fillStyle='#ff0';X.beginPath();X.arc(ex+12,ey+10,2,0,Math.PI*2);X.fill();
    let sd=e.dir<0?-6:20;
    X.fillStyle='#44aa66';X.beginPath();X.roundRect(ex+sd,ey-1,8,26,3);X.fill();
    X.fillStyle='rgba(100,255,150,.15)';X.beginPath();X.roundRect(ex+sd-2,ey-3,12,30,4);X.fill();
  }
  X.globalAlpha=1;
}

function drawAirMan(){
  if(!boss.alive&&!boss.defeated)return;
  if(!boss.active)return;
  if(boss.inv>0&&Math.floor(boss.inv/2)%2)return;
  let bx=boss.x-camX,by=boss.y-camY;

  let aurA=boss.phase>=1?.2:.1;
  aurA+=Math.sin(frame*.08)*.05;
  let aurC=boss.phase>=2?'rgba(255,50,50,':'rgba(100,180,255,';
  X.fillStyle=aurC+aurA+')';X.beginPath();X.arc(bx+24,by+28,45+Math.sin(frame*.1)*5,0,Math.PI*2);X.fill();

  X.save();
  let la=boss.og?Math.sin(frame*.15)*4:0;
  X.fillStyle='#2255aa';
  X.fillRect(bx+8,by+44,14,14+la);X.fillRect(bx+26,by+44,14,14-la);
  X.fillStyle='#1a44aa';
  X.beginPath();X.roundRect(bx+6,by+54+Math.max(0,la),16,6,2);X.fill();
  X.beginPath();X.roundRect(bx+24,by+54-Math.min(0,la),16,6,2);X.fill();

  let bdG=X.createLinearGradient(bx,by+12,bx+48,by+46);
  bdG.addColorStop(0,'#3388dd');bdG.addColorStop(1,'#2266bb');
  X.fillStyle=bdG;X.beginPath();X.roundRect(bx+4,by+16,40,30,5);X.fill();

  boss.fanAngle+=boss.at>0?.3:.08;
  X.save();X.translate(bx+24,by+32);X.rotate(boss.fanAngle);
  X.fillStyle='#aaa';
  for(let i=0;i<6;i++){
    X.save();X.rotate(i*Math.PI/3);
    X.fillRect(-2,-12,4,12);X.restore();
  }
  X.restore();
  X.fillStyle='#555';X.beginPath();X.arc(bx+24,by+32,5,0,Math.PI*2);X.fill();
  X.strokeStyle='#888';X.lineWidth=2;X.beginPath();X.arc(bx+24,by+32,12,0,Math.PI*2);X.stroke();

  X.fillStyle='#2266cc';
  X.beginPath();X.roundRect(bx-6,by+18,14,22,4);X.fill();
  X.beginPath();X.roundRect(bx+40,by+18,14,22,4);X.fill();
  X.fillStyle='#3377dd';
  X.beginPath();X.arc(bx+1,by+42,6,0,Math.PI*2);X.fill();
  X.beginPath();X.arc(bx+47,by+42,6,0,Math.PI*2);X.fill();

  let hG=X.createRadialGradient(bx+24,by+6,0,bx+24,by+10,20);
  hG.addColorStop(0,'#55aaff');hG.addColorStop(1,'#2266cc');
  X.fillStyle=hG;X.beginPath();X.arc(bx+24,by+10,18,0,Math.PI*2);X.fill();

  X.fillStyle='#fff';
  X.beginPath();X.ellipse(bx+16,by+8,5,6,-.1,0,Math.PI*2);X.fill();
  X.beginPath();X.ellipse(bx+32,by+8,5,6,.1,0,Math.PI*2);X.fill();
  X.fillStyle='#111';
  X.beginPath();X.ellipse(bx+17,by+9,3,4,0,0,Math.PI*2);X.fill();
  X.beginPath();X.ellipse(bx+31,by+9,3,4,0,0,Math.PI*2);X.fill();
  X.fillStyle='#f22';
  X.beginPath();X.arc(bx+17,by+8,1.2,0,Math.PI*2);X.fill();
  X.beginPath();X.arc(bx+31,by+8,1.2,0,Math.PI*2);X.fill();
  X.strokeStyle='#114';X.lineWidth=2.5;
  X.beginPath();X.moveTo(bx+10,by+2);X.lineTo(bx+20,by+5);X.stroke();
  X.beginPath();X.moveTo(bx+38,by+2);X.lineTo(bx+28,by+5);X.stroke();

  let mouthOpen=boss.at>0?6:3;
  X.fillStyle='#111';
  X.beginPath();X.ellipse(bx+24,by+17,8,mouthOpen,0,0,Math.PI*2);X.fill();
  X.fillStyle='#fff';
  for(let i=0;i<5;i++){X.fillRect(bx+14+i*4,by+17-mouthOpen+1,3,3)}
  for(let i=0;i<5;i++){X.fillRect(bx+14+i*4,by+17+mouthOpen-4,3,3)}

  X.fillStyle='#4499ee';
  X.beginPath();X.moveTo(bx+24,by-16);X.lineTo(bx+18,by);X.lineTo(bx+30,by);X.fill();
  X.fillStyle='#55bbff';
  X.beginPath();X.moveTo(bx+24,by-12);X.lineTo(bx+20,by);X.lineTo(bx+28,by);X.fill();

  if(boss.phase>=2){
    X.fillStyle=`rgba(255,100,0,${.2+Math.sin(frame*.15)*.15})`;
    X.beginPath();X.arc(bx+24,by+28,50,0,Math.PI*2);X.fill();
  }

  X.restore();
}

function drawBullets(){
  pBul.forEach(b=>{
    let bx=b.x-camX,by=b.y-camY;
    let sz=b.charged?10:7;
    let bG=X.createRadialGradient(bx+4,by+4,0,bx+4,by+4,sz);
    if(b.charged){bG.addColorStop(0,'#fff');bG.addColorStop(.3,'#00ffcc');bG.addColorStop(1,'rgba(0,255,200,0)')}
    else{bG.addColorStop(0,'#fff');bG.addColorStop(.3,'#ffff44');bG.addColorStop(1,'rgba(255,255,0,0)')}
    X.fillStyle=bG;X.beginPath();X.arc(bx+4,by+4,sz,0,Math.PI*2);X.fill();
    X.fillStyle=b.charged?'#aff':'#fff';X.beginPath();X.arc(bx+4,by+4,b.charged?5:3,0,Math.PI*2);X.fill();
  });
  eBul.forEach(b=>{
    let bx=b.x-camX,by=b.y-camY;
    if(b.tornado){
      X.save();X.translate(bx+6,by+6);X.rotate(frame*.15);
      X.fillStyle=`rgba(150,200,255,${.6+Math.sin(frame*.2)*.2})`;
      for(let i=0;i<3;i++){X.save();X.rotate(i*Math.PI*2/3);
        X.beginPath();X.ellipse(0,0,10,4,0,0,Math.PI*2);X.fill();X.restore()}
      X.fillStyle='#fff';X.beginPath();X.arc(0,0,3,0,Math.PI*2);X.fill();
      X.restore();
    }else{
      let eG=X.createRadialGradient(bx+4,by+4,0,bx+4,by+4,7);
      eG.addColorStop(0,'#fff');eG.addColorStop(.3,'#ff4488');eG.addColorStop(1,'rgba(255,0,80,0)');
      X.fillStyle=eG;X.beginPath();X.arc(bx+4,by+4,7,0,Math.PI*2);X.fill();
    }
  });
}

function drawParts(){
  parts.forEach(p=>{X.globalAlpha=Math.min(1,p.life/12);
    if(p.type===1){X.fillStyle=p.col;X.beginPath();X.moveTo(p.x-camX,p.y-camY-p.sz);
      X.lineTo(p.x-camX+p.sz*.5,p.y-camY);X.lineTo(p.x-camX,p.y-camY+p.sz);
      X.lineTo(p.x-camX-p.sz*.5,p.y-camY);X.fill()}
    else{X.fillStyle=p.col;X.beginPath();X.arc(p.x-camX,p.y-camY,p.sz,0,Math.PI*2);X.fill()}
  });X.globalAlpha=1;
}

function drawFloatTexts(){
  floatTexts.forEach(ft=>{
    X.globalAlpha=Math.min(1,ft.life/20);
    X.fillStyle=ft.col;X.font='bold 12px "Courier New",monospace';X.textAlign='center';
    X.fillText(ft.text,ft.x-camX,ft.y-camY);
  });X.globalAlpha=1;
}

function updPlayer(){
  if(P.dead)return;
  if(P.teleportIn>0){P.teleportIn--;return}

  P.vx=0;
  if(P.sliding){
    P.vx=SPD*2*P.face;P.slideTimer--;
    if(P.slideTimer<=0||(!P.og&&!P.climbing)){P.sliding=0;P.h=30;P.y-=12}
  }else{
    if(K.l){P.vx=-SPD;P.face=-1}
    if(K.r){P.vx=SPD;P.face=1}
  }

  let onLad=isLad(P.x+P.w/2,P.y+P.h/2)||isLad(P.x+P.w/2,P.y+P.h);
  if(onLad&&K.u){P.climbing=1;P.vy=-3;P.og=0}
  else if(P.climbing&&!onLad)P.climbing=0;
  if(P.climbing){P.vy=K.u?-3:(K.l||K.r?0:1);if(P.og)P.climbing=0}

  if(K.j&&P.og&&!P.climbing&&!P.sliding){P.vy=JF;P.og=0}

  if(slPress&&P.og&&!P.sliding&&!P.climbing){
    P.sliding=1;P.slideTimer=18;P.h=18;P.y+=12;slPress=0;
    boom(P.x,P.y+P.h,'rgba(200,200,255,.5)',4);
  }
  slPress=0;

  if(K.s){P.chargeTimer++;if(P.chargeTimer===30)sparkle(P.x+11,P.y+5,'#88eeff');
    if(P.chargeTimer===60)sparkle(P.x+11,P.y+5,'#00ffcc')}
  else if(P.chargeTimer>0){
    if(pBul.length<5){
      let charged=P.chargeTimer>=60?2:P.chargeTimer>=30?1:0;
      pBul.push({x:P.x+(P.face>0?P.w:-8),y:P.y+(P.sliding?4:10),
        vx:BSPD*P.face*(charged?1.3:1),w:8,h:8,life:55,dmg:charged===2?4:charged===1?2:1,charged:charged>0});
      P.st=charged?12:8;
      if(charged)boom(P.x+(P.face>0?P.w+4:-4),P.y+12,charged===2?'#0fc':'#8ef',charged*3);
    }
    P.chargeTimer=0;
  }

  if(sPress&&P.st<=0&&pBul.length<5&&P.chargeTimer<5){
    pBul.push({x:P.x+(P.face>0?P.w:-8),y:P.y+(P.sliding?4:10),vx:BSPD*P.face,w:8,h:8,life:55,dmg:1,charged:0});
    P.st=8;sPress=0;
  }
  if(P.st>0)P.st--;

  if(moveEnt(P))P.hp=0;

  // „Éú„ÇπÈÉ®Â±ã„Åß„ÅÆ„Éó„É¨„Ç§„É§„ÉºÁßªÂãïÂà∂Èôê
  if(bossRoomCamLocked){
    let leftLimit=BOSS_ROOM_START*T;
    let rightLimit=(BOSS_ROOM_START+BOSS_ROOM_WIDTH)*T-P.w;
    if(P.x<leftLimit)P.x=leftLimit;
    if(P.x>rightLimit)P.x=rightLimit;
  }

  let tc=tileAt(P.x+P.w/2,P.y+P.h-2);
  if(tc===3){dmgP(4);P.vy=-6}

  let cpTile=Math.floor(P.x/T);
  [55,110,170].forEach(cp=>{if(cpTile>=cp&&checkpoint<cp){checkpoint=cp;
    addFloatText(P.x,P.y-20,'CHECKPOINT!','#4f4');screenFlash=8}});

  let playerTileX = Math.floor(P.x/T);
  
  if(playerTileX >= 218 && playerTileX < DOOR_X && doorState === 0){
    doorState = 1;
    doorAnimTimer = 0;
    screenFlash = 12;
    addFloatText(DOOR_X*T, 12*T, 'üö™ DOOR OPEN!', '#ff0');
    boom(DOOR_X*T+16, 12*T, '#ff0', 15);
  }
  
  if(doorState === 1){
    doorAnimTimer++;
  }
  
  if(playerTileX > DOOR_X && doorState === 1){
    doorState = 2;
    screenFlash = 8;
    camShake = 6;
    addFloatText(DOOR_X*T, 12*T, 'üîí LOCKED!', '#f44');
    boom(DOOR_X*T+16, 12*T, '#f44', 12);
  }

  items.forEach(it=>{
    if(!it.alive)return;
    if(Math.abs(P.x-it.x)<20&&Math.abs(P.y-it.y)<20){
      it.alive=0;
      if(it.type==='eSmall'){P.hp=Math.min(P.mhp,P.hp+4);addFloatText(it.x,it.y-10,'+4 HP','#4af');score+=100}
      else if(it.type==='eLarge'){P.hp=Math.min(P.mhp,P.hp+10);addFloatText(it.x,it.y-10,'+10 HP','#f84');score+=200}
      else if(it.type==='life'){lives++;addFloatText(it.x,it.y-10,'1UP!','#f44');score+=500}
      boom(it.x,it.y,'#fff',8);
    }
  });

  if(P.x<0)P.x=0;if(P.inv>0)P.inv--;
  if(P.hp<=0&&!P.dead){
    P.dead=1;boom(P.x+11,P.y+15,'#4488ff',24);camShake=10;screenFlash=15;
    lives--;
    setTimeout(()=>{
      if(lives<=0){over=1;showOvl('üíÄ GAME OVER','SCORE: '+score,'CONTINUE?')}
      else{respawn()}
    },1500);
  }
  document.getElementById('php').style.width=(P.hp/P.mhp*100)+'%';
  if(Math.abs(P.vx)>.5&&P.og)P.runFrame+=.25;

  document.getElementById('scoreDisp').textContent='SCORE: '+score;
  document.getElementById('lifeDisp').textContent='LIFE: '+'‚òÖ'.repeat(Math.max(0,lives))+'‚òÜ'.repeat(Math.max(0,3-lives));
  document.getElementById('weaponDisp').textContent=P.chargeTimer>60?'WEAPON: FULL CHARGE':P.chargeTimer>30?'WEAPON: CHARGING..':'WEAPON: P.BUSTER';
}

function respawn(){
  if(doorState === 2){
    P.x = (DOOR_X + 2) * T;
    P.y = 14 * T;
  }else{
    P.x=checkpoint*T+60;P.y=300;
  }
  P.vx=0;P.vy=0;P.hp=P.mhp;P.dead=0;P.inv=90;P.teleportIn=40;
  P.sliding=0;P.h=30;P.chargeTimer=0;P.climbing=0;
  pBul=[];eBul=[];
}

function dmgP(d){
  if(P.inv>0||P.dead||P.teleportIn>0)return;
  P.hp-=d;P.inv=50;P.vx=-P.face*4;P.vy=-4;
  boom(P.x+11,P.y+12,'#fff',8);camShake=5;
}

function updBul(){
  pBul=pBul.filter(b=>{b.x+=b.vx;b.life--;
    if(solid(b.x+4,b.y+4)){boom(b.x,b.y,b.charged?'#0fc':'#ff4',b.charged?8:5);return false}return b.life>0});
  eBul=eBul.filter(b=>{b.x+=b.vx;b.y+=(b.vy||0);b.life--;
    if(solid(b.x+4,b.y+4))return false;
    if(!P.dead&&P.teleportIn<=0&&rCol(b,P)){dmgP(b.tornado?3:2);return false}return b.life>0});
}

function dropItem(x,y){
  let r=Math.random();
  if(r<.25){items.push({x,y,w:16,h:16,type:'eSmall',alive:1,bobOff:Math.random()*6.28})}
  else if(r<.35){items.push({x,y,w:16,h:16,type:'eLarge',alive:1,bobOff:Math.random()*6.28})}
  else if(r<.38){items.push({x,y,w:16,h:16,type:'life',alive:1,bobOff:Math.random()*6.28})}
}

function updEnemies(){
  enemies.forEach(e=>{
    if(!e.alive)return;
    let dist=Math.abs(e.x-P.x);if(dist>W*1.3)return;
    e.timer++;

    if(e.type==='goblin'){
      e.vx=1.5*e.dir;if(e.timer%180===0)e.dir*=-1;
      if(e.timer%80===0&&dist<300){e.vy=-8}
      moveEnt(e);
    }else if(e.type==='fly'){
      e.dir=P.x<e.x?-1:1;
      if(e.timer%50===0&&dist<380)eBul.push({x:e.x+12,y:e.y+12,vx:4*e.dir,vy:1.5,w:8,h:8,life:50});
    }else if(e.type==='cannon'){
      if(e.timer%28===0&&dist<420){
        let a=Math.atan2(P.y-e.y,P.x-e.x);
        eBul.push({x:e.x+12,y:e.y+15,vx:Math.cos(a)*5.5,vy:Math.sin(a)*5.5,w:8,h:8,life:50});
        e.flash=6;
      }
      moveEnt(e);
    }else if(e.type==='shield'){
      e.dir=P.x<e.x?-1:1;e.vx=1*e.dir;
      if(e.timer%60===0&&dist<400)eBul.push({x:e.x+12,y:e.y+10,vx:5*e.dir,vy:0,w:8,h:8,life:55});
      moveEnt(e);
    }

    pBul.forEach((b,bi)=>{
      if(!e.alive)return;
      if(rCol(b,e)){
        if(e.type==='shield'){
          let hitShieldSide=(b.vx>0&&e.dir<0)||(b.vx<0&&e.dir>0);
          if(hitShieldSide){b.vx*=-1;boom(b.x,b.y,'#4a8',4);return}
        }
        e.hp-=b.dmg||1;pBul.splice(bi,1);boom(b.x,b.y,'#ff4',6);e.flash=4;
        if(e.hp<=0){
          e.alive=0;boom(e.x+12,e.y+14,'#f80',18);
          score+=e.type==='cannon'?400:e.type==='shield'?300:200;
          addFloatText(e.x,e.y-10,'+'+(e.type==='cannon'?400:e.type==='shield'?300:200),'#ff0');
          dropItem(e.x+4,e.y+4);
        }
      }
    });
    if(!P.dead&&e.alive&&P.teleportIn<=0&&rCol(e,P)){
      if(P.sliding){
        if(e.type==='goblin'){e.alive=0;boom(e.x+12,e.y+14,'#f80',14);score+=200;
          addFloatText(e.x,e.y-10,'SLIDE!','#0ff');dropItem(e.x+4,e.y+4)}
        else dmgP(2);
      }else dmgP(2);
    }
  });
}

function updBoss(){
  if(!boss.alive&&!boss.defeated)return;
  if(boss.defeated){
    boss.defeatTimer++;
    if(boss.defeatTimer%15===0)boom(boss.x+Math.random()*48,boss.y+Math.random()*56,
      ['#ff0','#f80','#f44','#fff','#4af'][Math.floor(Math.random()*5)],16);
    if(boss.defeatTimer>180&&!clear){
      clear=1;screenFlash=30;
      score+=5000;
      showOvl('üéâ STAGE CLEAR! üéâ','AIR MAN DEFEATED!<br>SCORE: '+score,'REPLAY');
    }
    return;
  }
  if(!boss.active && doorState === 2){
    boss.active=1;bossIntro=180;
    // „Éú„Çπ‰ΩçÁΩÆ„Çí„Éú„ÇπÈÉ®Â±ã‰∏≠Â§Æ„Å´ÈÖçÁΩÆ
    boss.x=(BOSS_ROOM_START+BOSS_ROOM_WIDTH/2)*T;
    boss.y=300;
    bossRoomCamLocked=1;
    document.getElementById('bhud').style.display='block';
    screenFlash=20;
  }
  if(!boss.active)return;
  if(bossIntro>0){
    bossIntro--;
    if(bossIntro===150)zoneLabel='‚ö† WARNING ‚ö†';
    if(bossIntro===100){zoneLabel='AIR MAN';zoneLT=120}
    if(bossIntro===50)screenFlash=10;
    if(bossIntro>100){
      boss.y=300-(bossIntro-100)*3;
      for(let i=0;i<2;i++)sparkle(boss.x+24+Math.random()*10-5,boss.y+Math.random()*56,'#88ccff');
    }
    return;
  }

  boss.timer++;boss.dir=P.x<boss.x?-1:1;
  boss.phase=boss.hp<boss.mhp*.3?2:boss.hp<boss.mhp*.6?1:0;
  let spd=2+boss.phase*.8;
  let fireRate=boss.phase===2?20:boss.phase===1?30:40;

  let cycle=boss.timer%240;
  if(cycle<80){
    if(cycle===1&&boss.og){boss.vy=-14-boss.phase*2;
      boom(boss.x+24,boss.y+56,'rgba(200,220,255,.5)',8)}
    boss.vx=spd*boss.dir;
    if(cycle%fireRate===0){
      let numT=3+boss.phase;
      for(let i=0;i<numT;i++){
        let angle=-Math.PI/3+i*(Math.PI*2/3)/(numT-1);
        if(boss.dir<0)angle=Math.PI-angle;
        eBul.push({x:boss.x+24,y:boss.y+32,vx:Math.cos(angle)*4,vy:Math.sin(angle)*4-2,
          w:12,h:12,life:80,tornado:1});
      }
      boss.at=15;boss.fanAngle+=2;
      for(let i=0;i<6;i++)windParticles.push({x:boss.x+24,y:boss.y+32,
        vx:(Math.random()-.5)*8+boss.dir*3,vy:(Math.random()-.5)*8-3,life:30,sz:2+Math.random()*3});
    }
  }else if(cycle<160){
    boss.vx=spd*1.5*boss.dir;
    if(cycle%50===0&&boss.og){boss.vy=-10}
    if(cycle%25===0){
      eBul.push({x:boss.x+24,y:boss.y+32,vx:5*boss.dir,vy:-1,w:12,h:12,life:60,tornado:1});
      boss.at=10;
    }
  }else{
    if(boss.og&&cycle===160){boss.vy=-16}
    boss.vy=Math.sin(frame*.08)*2-1;
    boss.vx=spd*.5*boss.dir;
    if(cycle%15===0&&boss.phase>=1){
      let a=Math.atan2(P.y-boss.y,P.x-boss.x);
      eBul.push({x:boss.x+24,y:boss.y+32,vx:Math.cos(a)*5,vy:Math.sin(a)*5,w:12,h:12,life:70,tornado:1});
      boss.at=8;
    }
  }

  if(boss.at>0)boss.at--;
  moveEnt(boss);
  
  // „Éú„Çπ„ÅÆÁßªÂãïÁØÑÂõ≤Âà∂ÈôêÔºà„Éú„ÇπÈÉ®Â±ãÂÜÖ„ÅÆ„ÅøÔºâ
  let bossLeftLimit=BOSS_ROOM_START*T;
  let bossRightLimit=(BOSS_ROOM_START+BOSS_ROOM_WIDTH)*T-boss.w;
  if(boss.x<bossLeftLimit)boss.x=bossLeftLimit;
  if(boss.x>bossRightLimit)boss.x=bossRightLimit;
  
  if(boss.inv>0)boss.inv--;

  pBul=pBul.filter(b=>{
    if(rCol(b,boss)&&boss.inv<=0){
      boss.hp-=(b.dmg||1);boss.inv=15;boss.flash=8;
      boom(b.x,b.y,'#ff4',10);camShake=4;
      addFloatText(b.x,b.y-15,'-'+(b.dmg||1),'#ff0');
      if(boss.hp<=0){
        boss.alive=0;boss.defeated=1;boss.defeatTimer=0;
        screenFlash=25;camShake=15;score+=5000;
      }
      return false;
    }return true;
  });
  if(!P.dead&&boss.alive&&P.teleportIn<=0&&rCol(boss,P))dmgP(4);
  document.getElementById('bhp').style.width=(Math.max(0,boss.hp)/boss.mhp*100)+'%';
}

function updParts(){
  parts=parts.filter(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=.08;p.vx*=.97;p.life--;return p.life>0});
  floatTexts=floatTexts.filter(ft=>{ft.y+=ft.vy;ft.life--;return ft.life>0});
  windParticles=windParticles.filter(wp=>{wp.x+=wp.vx;wp.y+=wp.vy;wp.vy+=.05;wp.life--;return wp.life>0});
  
  let zone=getZone(P.x);
  if(frame%6===0){
    if(zone===1)sparkle(camX+Math.random()*W,camY+Math.random()*H,'rgba(200,230,255,.3)');
    if(zone===4&&boss.active)sparkle(camX+Math.random()*W,camY+Math.random()*H,'rgba(255,100,100,.25)');
  }
}

function updCam(){
  // „Éú„ÇπÊà¶ÊôÇ„ÅØ„Ç´„É°„É©Âõ∫ÂÆö
  if(bossRoomCamLocked){
    let fixedCamX=BOSS_ROOM_START*T;
    let fixedCamY=0;
    // ÁîªÈù¢„Çµ„Ç§„Ç∫„Å´Âêà„Çè„Åõ„Å¶Ë™øÊï¥
    let roomPixelWidth=BOSS_ROOM_WIDTH*T;
    if(W<roomPixelWidth){
      // ÁîªÈù¢„ÅåÈÉ®Â±ã„Çà„ÇäÂ∞è„Åï„ÅÑÂ†¥Âêà„ÄÅ„Éó„É¨„Ç§„É§„Éº„ÇíËøΩÂæìÔºàÁØÑÂõ≤ÂÜÖ„ÅßÔºâ
      let targetX=P.x-W/2;
      if(targetX<BOSS_ROOM_START*T)targetX=BOSS_ROOM_START*T;
      if(targetX>(BOSS_ROOM_START+BOSS_ROOM_WIDTH)*T-W)targetX=(BOSS_ROOM_START+BOSS_ROOM_WIDTH)*T-W;
      fixedCamX=targetX;
    }else{
      // ÁîªÈù¢„ÅåÈÉ®Â±ã„Çà„ÇäÂ§ß„Åç„ÅÑÂ†¥Âêà„ÄÅ‰∏≠Â§Æ„Å´Âõ∫ÂÆö
      fixedCamX=BOSS_ROOM_START*T-(W-roomPixelWidth)/2;
    }
    camX+=(fixedCamX-camX)*.15;
    camY+=(fixedCamY-camY)*.15;
  }else{
    let tx=P.x-W/3,ty=P.y-H*.42;
    camX+=(tx-camX)*.09;camY+=(ty-camY)*.09;
    if(camX<0)camX=0;if(camX>SW*T-W)camX=Math.max(0,SW*T-W);
    if(camY>SH*T-H)camY=SH*T-H;if(camY<0)camY=0;
  }
  if(camShake>0){camX+=Math.sin(frame*2.5)*camShake;camY+=Math.cos(frame*3.5)*camShake*.6;camShake=Math.max(0,camShake-.4)}
}

function checkZone(){
  let z=getZone(P.x);
  let n=['‚òÅ SKY GARDENS ‚òÅ','üí® WIND TUNNELS üí®','üè∞ CLOUD FORTRESS üè∞','üóº STORM TOWER üóº','‚ö° BOSS CHAMBER ‚ö°'][z];
  if(n!==zoneLabel&&!bossIntro){zoneLabel=n;zoneLT=150}
}

function showOvl(t,sub,btn){
  let o=document.getElementById('overlay');o.style.display='flex';
  o.innerHTML=`<h1 style="color:#4af;text-shadow:0 0 30px #4af">${t}</h1>
  <p style="color:#ccc">${sub}</p>
  <button class="sbtn" onclick="location.reload()">${btn}</button>`;
}

function drawWindParts(){
  windParticles.forEach(wp=>{
    X.globalAlpha=wp.life/30;
    X.fillStyle='rgba(200,230,255,.5)';X.beginPath();X.arc(wp.x-camX,wp.y-camY,wp.sz,0,Math.PI*2);X.fill();
  });X.globalAlpha=1;
}

function loop(){
  requestAnimationFrame(loop);
  if(!started||over||clear||paused)return;
  frame++;

  if(screenFadeIn>0){screenFadeIn--}
  else{
    updPlayer();updBul();updEnemies();updBoss();updParts();updCam();checkZone();
  }

  X.save();
  X.clearRect(0,0,W,H);
  drawBG();drawTiles();drawItems();drawParts();drawWindParts();
  enemies.forEach(e=>drawEnemy(e));
  drawAirMan();drawPlayer();drawBullets();drawFloatTexts();

  if(zoneLT>0){zoneLT--;
    let a=zoneLT>130?((150-zoneLT)/20):zoneLT<25?(zoneLT/25):1;
    X.globalAlpha=a;X.fillStyle='#fff';X.font='bold clamp(14px,3vw,20px) "Courier New",monospace';
    X.textAlign='center';X.shadowColor='#000';X.shadowBlur=8;
    X.fillText(zoneLabel,W/2,55);X.shadowBlur=0;X.globalAlpha=1;
  }

  if(P.x/T>210&&P.x/T<218&&doorState===0){
    let a=.6+Math.sin(frame*.12)*.3;
    X.fillStyle=`rgba(255,200,50,${a})`;X.font='bold 18px monospace';X.textAlign='center';
    X.fillText('‚Üí BOSS AHEAD ‚Üí',W/2,50);
  }

  if(bossIntro>0){
    let a=bossIntro>150?.8:bossIntro/150*.6;
    X.fillStyle=`rgba(0,0,0,${a})`;X.fillRect(0,0,W,H);
    if(bossIntro<150&&bossIntro>50){
      X.fillStyle='#fff';X.font='bold 28px "Courier New",monospace';X.textAlign='center';
      X.shadowColor='#f44';X.shadowBlur=20;
      X.fillText('AIR MAN',W/2,H/2-10);
      X.font='14px "Courier New",monospace';X.fillStyle='#aaa';
      X.fillText('‚Äî MASTER OF WIND ‚Äî',W/2,H/2+20);
      X.shadowBlur=0;
    }
  }

  if(screenFlash>0){X.fillStyle=`rgba(255,255,255,${screenFlash/30})`;X.fillRect(0,0,W,H);screenFlash--}
  if(screenFadeIn>0){X.fillStyle=`rgba(0,0,0,${screenFadeIn/60})`;X.fillRect(0,0,W,H)}

  if(boss.defeated){
    X.fillStyle=`rgba(255,255,255,${Math.min(.5,boss.defeatTimer/180*.5)+Math.sin(frame*.2)*.1})`;
    X.fillRect(0,0,W,H);
  }

  X.restore();
}

document.getElementById('startBtn').onclick=()=>{
  document.getElementById('overlay').style.display='none';
  started=1;zoneLT=150;zoneLabel='‚òÅ SKY GARDENS ‚òÅ';
  lockOrientation();
};

loop();
</script>
</body>
</html>
