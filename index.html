<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Game 6 - È≠Ç„ÅÆÊúÄÁµÇÁ´†: ROCKMAN vs AIRMAN</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#000;touch-action:none;-webkit-user-select:none;user-select:none}
canvas{display:block}
#ui{position:fixed;bottom:10px;left:0;right:0;display:flex;justify-content:space-between;padding:0 10px;pointer-events:none;z-index:10}
.cg{display:flex;gap:6px;pointer-events:auto;align-items:flex-end}
.dpad{display:grid;grid-template-columns:52px 52px 52px;grid-template-rows:52px 52px;gap:4px}
.b{border-radius:50%;border:2px solid rgba(255,255,255,.45);color:#fff;font-weight:bold;
display:flex;align-items:center;justify-content:center;cursor:pointer;-webkit-tap-highlight-color:transparent;
backdrop-filter:blur(4px);text-shadow:0 0 6px #fff;font-family:sans-serif;
transition:transform .07s;box-shadow:0 2px 10px rgba(0,0,0,.4),inset 0 1px 0 rgba(255,255,255,.15)}
.b:active{transform:scale(.87);filter:brightness(1.4)}
.bd{width:50px;height:50px;font-size:20px;background:radial-gradient(circle at 36% 30%,rgba(100,170,255,.6),rgba(20,70,200,.35))}
.bj{width:66px;height:66px;font-size:11px;background:radial-gradient(circle at 36% 30%,rgba(255,215,60,.6),rgba(200,140,20,.4));
border-color:rgba(255,220,100,.5)}
.bs{width:66px;height:66px;font-size:11px;background:radial-gradient(circle at 36% 30%,rgba(255,100,100,.6),rgba(200,40,40,.4));
border-color:rgba(255,120,120,.5)}
.bsl{width:58px;height:58px;font-size:10px;background:radial-gradient(circle at 36% 30%,rgba(100,255,200,.5),rgba(20,160,100,.35));
border-color:rgba(100,255,180,.5)}
.empty{visibility:hidden}
#overlay{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;
align-items:center;justify-content:center;z-index:100;font-family:'Courier New',monospace;
background:radial-gradient(ellipse at 50% 40%,rgba(0,30,80,.96),rgba(0,0,10,.99))}
#overlay h1{margin-bottom:10px;letter-spacing:3px}
#overlay p{color:#aaa;margin-bottom:18px;font-size:13px;text-align:center;line-height:1.8}
.sbtn{padding:16px 48px;font-size:18px;background:linear-gradient(135deg,#1a55bb,#3399ff);
color:#fff;border:none;border-radius:12px;cursor:pointer;font-family:inherit;
box-shadow:0 0 30px rgba(50,140,255,.5),inset 0 1px 0 rgba(255,255,255,.25);
letter-spacing:2px;text-transform:uppercase;transition:all .15s;margin:6px}
.sbtn:hover{background:linear-gradient(135deg,#2266cc,#44aaff);transform:scale(1.06);
box-shadow:0 0 40px rgba(50,140,255,.7)}
.mbtn{padding:12px 36px;font-size:14px;background:rgba(255,255,255,.1);
color:#aaa;border:1px solid rgba(255,255,255,.25);border-radius:10px;cursor:pointer;
font-family:inherit;letter-spacing:1px;transition:all .15s;margin:6px}
.mbtn:hover{background:rgba(255,255,255,.2);color:#fff}
#hud{position:fixed;top:8px;left:8px;z-index:10;display:flex;gap:14px;align-items:flex-start}
.hbar{display:flex;flex-direction:column;gap:2px}
.hlab{color:#fff;font:bold 10px 'Courier New',monospace;text-shadow:0 1px 4px #000,0 0 10px rgba(0,100,255,.3)}
.hcon{width:114px;height:11px;background:rgba(0,0,0,.65);border:1px solid rgba(255,255,255,.3);border-radius:5px;overflow:hidden;
box-shadow:inset 0 2px 4px rgba(0,0,0,.6)}
.hfill{height:100%;border-radius:4px;transition:width .18s;position:relative;overflow:hidden}
.hfill::after{content:'';position:absolute;top:0;left:0;right:0;height:45%;
background:linear-gradient(180deg,rgba(255,255,255,.35),transparent);border-radius:4px 4px 0 0}
#scoreDisp{position:fixed;top:8px;right:8px;color:#ffe040;font:bold 12px 'Courier New',monospace;z-index:10;
text-shadow:0 0 10px rgba(255,224,64,.5),0 1px 3px #000}
#lifeDisp{position:fixed;top:26px;right:8px;color:#5f5;font:bold 11px 'Courier New',monospace;z-index:10;text-shadow:0 1px 3px #000}
#weaponDisp{position:fixed;top:42px;right:8px;color:#8cf;font:bold 10px 'Courier New',monospace;z-index:10;text-shadow:0 1px 3px #000}
#comboDisp{position:fixed;top:58px;right:8px;color:#f84;font:bold 11px 'Courier New',monospace;z-index:10;text-shadow:0 0 8px rgba(255,136,68,.5);display:none}
</style>
</head>
<body>
<div id="overlay">
<h1 style="color:#b464ff;text-shadow:0 0 30px #b464ff,0 0 60px #8a2be2;font-size:clamp(18px,4.5vw,28px)">üîÆ È≠Ç„ÅÆÊúÄÁµÇÁ´† üîÆ</h1>
<h1 style="color:#4af;text-shadow:0 0 30px #4af,0 0 60px #28f;font-size:clamp(22px,5.5vw,36px)">‚ö° ROCKMAN ‚ö°</h1>
<h1 style="color:#f84;text-shadow:0 0 25px #f84,0 0 50px #c40;font-size:clamp(16px,4vw,28px)">vs AIR MAN</h1>
<p>‚Äî GAME 6 : FINAL STAGE ‚Äî<br><br>
üéÆ ÁßªÂãïÔºö‚Üê ‚Üë ‚Üí / „Ç∏„É£„É≥„ÉóÔºöJUMP<br>
üî´ „Ç∑„Éß„ÉÉ„ÉàÔºöSHOTÔºàÈï∑Êäº„Åó„ÉÅ„É£„Éº„Ç∏Ôºâ<br>
üí® „Çπ„É©„Ç§„Éá„Ç£„É≥„Ç∞ÔºöSLIDE</p>
<button class="sbtn" id="startBtn">READY</button>
<button class="mbtn" onclick="goBack()">‚Üê „É°„Éã„É•„Éº„Å´Êàª„Çã</button>
</div>
<div id="hud">
<div class="hbar"><span class="hlab">‚òÖ ROCK</span><div class="hcon"><div class="hfill" id="php" style="width:100%;background:linear-gradient(90deg,#2d2,#6f6)"></div></div></div>
<div class="hbar" id="bhud" style="display:none"><span class="hlab">‚ò† AIRMAN</span><div class="hcon"><div class="hfill" id="bhp" style="width:100%;background:linear-gradient(90deg,#d33,#f77)"></div></div></div>
</div>
<div id="scoreDisp">SCORE: 0</div>
<div id="lifeDisp">LIFE: ‚òÖ‚òÖ‚òÖ</div>
<div id="weaponDisp">WEAPON: P.BUSTER</div>
<div id="comboDisp"></div>
<canvas id="c"></canvas>
<div id="ui">
<div class="cg"><div class="dpad">
<div class="empty"></div><button class="b bd" id="bU">‚ñ≤</button><div class="empty"></div>
<button class="b bd" id="bL">‚óÄ</button><div class="empty"></div><button class="b bd" id="bR">‚ñ∂</button>
</div></div>
<div class="cg" style="flex-direction:column;align-items:flex-end;gap:7px">
<div style="display:flex;gap:7px">
<button class="b bs" id="bS">SHOT</button><button class="b bj" id="bJ">JUMP</button>
</div><button class="b bsl" id="bSL">SLIDE</button>
</div></div>

<script>
const GAME_NUMBER=6;
function goBack(){window.location.href='index.html?menu=1'}
function clearGame(){localStorage.setItem('gameClear_'+GAME_NUMBER,'true')}

const C=document.getElementById('c'),X=C.getContext('2d');
let W,H;function resize(){W=C.width=innerWidth;H=C.height=innerHeight}
resize();addEventListener('resize',resize);

let started=0,over=0,clear=0,paused=0,frame=0;
let score=0,lives=3,checkpoint=0;
let doorState=0,doorAnimTimer=0;
let combo=0,comboTimer=0,maxCombo=0;

const K={l:0,r:0,u:0,j:0,s:0,sl:0};let sPress=0,slPress=0;

function bind(id,k){const e=document.getElementById(id);
['touchstart','mousedown'].forEach(v=>e.addEventListener(v,ev=>{ev.preventDefault();K[k]=1;if(k==='s')sPress=1;if(k==='sl')slPress=1}));
['touchend','mouseup','touchcancel'].forEach(v=>e.addEventListener(v,ev=>{ev.preventDefault();K[k]=0}));}
bind('bL','l');bind('bR','r');bind('bU','u');bind('bJ','j');bind('bS','s');bind('bSL','sl');
addEventListener('keydown',e=>{
if(e.key==='ArrowLeft'||e.key==='a')K.l=1;if(e.key==='ArrowRight'||e.key==='d')K.r=1;
if(e.key==='ArrowUp'||e.key==='w')K.u=1;if(e.key==='ArrowDown')K.sl=1;
if(e.key===' ')K.j=1;if(e.key==='z'||e.key==='j'){K.s=1;sPress=1}
if(e.key==='x'||e.key==='c'){K.sl=1;slPress=1}if(e.key==='Escape')paused=!paused;
});
addEventListener('keyup',e=>{
if(e.key==='ArrowLeft'||e.key==='a')K.l=0;if(e.key==='ArrowRight'||e.key==='d')K.r=0;
if(e.key==='ArrowUp'||e.key==='w')K.u=0;if(e.key==='ArrowDown')K.sl=0;
if(e.key===' ')K.j=0;if(e.key==='z'||e.key==='j')K.s=0;
if(e.key==='x'||e.key==='c')K.sl=0;
});

const T=32,G=0.55,SPD=3.8,JF=-11.5,BSPD=9,SW=280,SH=20,DOOR_X=222;

const stars=[];
for(let i=0;i<180;i++)stars.push({x:Math.random()*3000,y:Math.random()*350,
sz:.4+Math.random()*2.2,tw:Math.random()*Math.PI*2,spd:.2+Math.random()*.6,
col:['#fff','#ccf','#ffc','#fcc','#cff'][Math.floor(Math.random()*5)]});

let items=[],map=[];

function genStage(){
map=[];for(let x=0;x<SW;x++){let c=[];for(let y=0;y<SH;y++)c.push(0);map.push(c)}
let gy;
for(let x=0;x<SW;x++){
  gy=16;
  if(x<55){gy=16+Math.round(Math.sin(x*.06)*1);if((x>18&&x<22)||(x>35&&x<39)||(x>48&&x<52))gy=99;}
  else if(x<110){gy=15;if((x>62&&x<66)||(x>78&&x<82)||(x>95&&x<99))gy=99;for(let y=0;y<3;y++)map[x][y]=12;}
  else if(x<170){gy=15;if((x>118&&x<122)||(x>138&&x<142)||(x>155&&x<159))gy=99;for(let y=0;y<2;y++)map[x][y]=13;}
  else if(x<220){gy=16;if((x>178&&x<182)||(x>195&&x<199)||(x>210&&x<214))gy=99;}
  else{gy=16;}
  if(gy<99)for(let y=gy;y<SH;y++)map[x][y]=(x<55)?1:(x<110)?14:(x<170)?15:16;
}
const pl=[[5,14],[6,14],[7,14],[10,12],[11,12],[12,12],[13,12],[16,10],[17,10],[18,10],
[19,13],[20,13],[21,13],[22,13],[25,11],[26,11],[27,11],[30,9],[31,9],[32,9],
[34,12],[35,12],[36,14],[37,14],[38,14],[39,14],[42,11],[43,11],[44,11],
[47,9],[48,9],[49,12],[50,12],[51,12],[52,12],[56,13],[57,13],[58,13],
[60,11],[61,11],[62,11],[63,9],[64,9],[65,9],[66,9],[68,13],[69,13],
[71,11],[72,11],[73,11],[75,8],[76,8],[77,8],[79,12],[80,12],[81,12],[82,12],
[84,10],[85,10],[87,13],[88,13],[89,13],[91,8],[92,8],[93,8],
[96,11],[97,11],[98,11],[99,11],[101,9],[102,9],[105,13],[106,13],[107,13],
[112,13],[113,13],[114,13],[116,11],[117,11],[118,11],[119,9],[120,9],[121,9],[122,9],
[124,13],[125,13],[127,11],[128,11],[129,11],[131,8],[132,8],[133,8],
[135,12],[136,12],[137,12],[139,10],[140,10],[141,10],[142,10],[144,13],[145,13],
[147,8],[148,8],[149,8],[151,11],[152,11],[154,13],[155,13],[156,13],
[158,9],[159,9],[160,9],[162,12],[163,12],[164,12],[166,10],[167,10],
[172,14],[173,14],[174,14],[176,12],[177,12],[178,12],[179,10],[180,10],[181,10],[182,10],
[184,13],[185,13],[187,11],[188,11],[189,11],[191,8],[192,8],[193,8],
[196,12],[197,12],[198,12],[199,12],[201,10],[202,10],[204,13],[205,13],[206,13],
[208,8],[209,8],[210,8],[211,11],[212,11],[213,11],[214,14],[216,13],[217,13],[218,13]];
pl.forEach(([px,py])=>{if(px<SW&&py<SH&&map[px][py]===0)map[px][py]=2});
[15,28,45,60,73,90,104,117,133,148,165,177,193,209].forEach(lx=>{if(lx<SW)for(let y=7;y<15;y++)if(map[lx][y]===0)map[lx][y]=9;});
[14,33,47,70,86,100,126,143,160,185,200,215].forEach(sx=>{if(sx<SW){let g2=SH-1;for(let y=0;y<SH;y++)if(map[sx][y]>=1&&map[sx][y]<=16&&map[sx][y]!==9){g2=y;break}if(g2>0&&map[sx][g2-1]===0)map[sx][g2-1]=3}});
[65,66,80,81,96,97].forEach(wx=>{if(wx<SW)for(let y=5;y<8;y++)if(map[wx][y]===0)map[wx][y]=17;});
[55,110,170].forEach(cx=>{if(cx<SW)map[cx][15]=18});
for(let y=10;y<16;y++)map[DOOR_X][y]=11;
[[12,11,'eSmall'],[40,13,'eSmall'],[67,8,'eLarge'],[93,7,'eLarge'],
[120,8,'eSmall'],[149,7,'eLarge'],[190,7,'eLarge'],[205,12,'life']].forEach(([ix,iy,it])=>{
  items.push({x:ix*T+8,y:iy*T+8,w:16,h:16,type:it,alive:1,bobOff:Math.random()*6.28});
});
}
genStage();

let P={x:60,y:420,w:22,h:30,vx:0,vy:0,og:0,face:1,hp:28,mhp:28,st:0,inv:0,dead:0,
climbing:0,sliding:0,slideTimer:0,chargeTimer:0,charged:0,runFrame:0,teleportIn:60,
wallJumpTimer:0,dashTrail:[],landDust:0};

let pBul=[],eBul=[];
let enemies=[];
function spawnEnemies(){
enemies=[];
const defs=[{x:180,t:'fly'},{x:350,t:'goblin'},{x:500,t:'fly'},{x:700,t:'cannon'},
{x:900,t:'goblin'},{x:1100,t:'fly'},{x:1300,t:'shield'},{x:1450,t:'goblin'},
{x:1600,t:'fly'},{x:1800,t:'cannon'},{x:2000,t:'goblin'},{x:2200,t:'fly'},
{x:2400,t:'shield'},{x:2600,t:'cannon'},{x:2800,t:'goblin'},{x:3000,t:'fly'},
{x:3200,t:'shield'},{x:3400,t:'cannon'},{x:3600,t:'goblin'},{x:3800,t:'fly'},
{x:4000,t:'cannon'},{x:4200,t:'shield'},{x:4400,t:'goblin'},{x:4600,t:'fly'},
{x:4800,t:'cannon'},{x:5000,t:'goblin'},{x:5200,t:'shield'},{x:5400,t:'fly'},
{x:5600,t:'cannon'},{x:5800,t:'goblin'},{x:6000,t:'fly'},{x:6200,t:'shield'},
{x:6400,t:'cannon'},{x:6600,t:'goblin'},{x:6800,t:'fly'}];
defs.forEach(d=>{
  let tx=Math.floor(d.x/T),gy2=15;
  if(tx<SW){for(let y=0;y<SH;y++){let t=map[tx][y];if(t===1||t===2||t===14||t===15||t===16){gy2=y;break}}}
  let ey=d.t==='fly'?gy2*T-70:gy2*T-28;
  enemies.push({x:d.x,y:ey,w:24,h:28,vx:0,vy:0,type:d.t,hp:d.t==='cannon'?4:d.t==='shield'?3:2,
    alive:1,og:0,dir:-1,timer:Math.random()*100|0,st:0,shielded:0,baseY:ey,angle:0,flash:0});
});
}
spawnEnemies();

let boss={x:7600,y:400,w:48,h:56,vx:0,vy:0,hp:28,mhp:28,alive:1,active:0,og:0,
dir:-1,timer:0,inv:0,at:0,pat:0,phase:0,flash:0,
fanAngle:0,tornadoTimer:0,introTimer:0,defeated:0,defeatTimer:0,
patTimer:0,patPhase:0,patCount:0,
dashTargetX:0,dashSpeed:0,slamState:0,slamY:0,
suctionActive:0,suctionTimer:0,
megaTornadoes:[],windWallTimer:0,
teleportTimer:0,teleportX:0,teleportY:0,visible:1,
lastPat:-1,patQueue:[],phaseTransition:0,phaseTransTimer:0,
eyeGlow:0,mouthOpen:3,armSwing:0};

let parts=[],floatTexts=[],windParticles=[];
let screenFlash=0,screenFadeIn=60,bossIntro=0;
let camX=0,camY=0,camShake=0;
let zoneLabel='',zoneLT=0;
let lightningTimer=0,lightningAlpha=0;

function tileAt(px,py){let tx=Math.floor(px/T),ty=Math.floor(py/T);
if(tx<0||tx>=SW||ty<0||ty>=SH)return 0;return map[tx][ty]}
function solid(px,py){let t=tileAt(px,py);let tx=Math.floor(px/T);
if(t===11&&tx===DOOR_X&&doorState===1)return false;return(t>=1&&t<=2)||(t>=11&&t<=16)}
function isLad(px,py){return tileAt(px,py)===9}
function isWind(px,py){return tileAt(px,py)===17}
function rCol(a,b){return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y}
function getZone(px){let tx=px/T;if(tx<55)return 0;if(tx<110)return 1;if(tx<170)return 2;if(tx<220)return 3;return 4}

function boom(x,y,col,n){n=n||14;for(let i=0;i<n;i++){
let ang=Math.random()*Math.PI*2,spd=1+Math.random()*5;
parts.push({x,y,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd-2,
life:20+Math.random()*22,col:col||'#ff0',sz:1.5+Math.random()*4.5,type:0})}}
function sparkle(x,y,col){parts.push({x,y,vx:(Math.random()-.5)*2,vy:-Math.random()*2.5-1,
life:32+Math.random()*25,col:col||'#fff',sz:1+Math.random()*2.5,type:1})}
function addFloatText(x,y,text,col){floatTexts.push({x,y,text,col:col||'#fff',life:55,vy:-1.5})}

function moveEnt(e){
e.x+=e.vx;
if(e.vx>0){if(solid(e.x+e.w,e.y+3)||solid(e.x+e.w,e.y+e.h-3)){e.x=Math.floor((e.x+e.w)/T)*T-e.w-.01;e.vx=0}}
else if(e.vx<0){if(solid(e.x,e.y+3)||solid(e.x,e.y+e.h-3)){e.x=Math.ceil(e.x/T)*T+.01;e.vx=0}}
if(!e.climbing){e.vy+=G;if(e.vy>13)e.vy=13}
e.y+=e.vy;e.og=0;
if(e.vy>=0){if(solid(e.x+3,e.y+e.h)||solid(e.x+e.w-3,e.y+e.h)){
e.y=Math.floor((e.y+e.h)/T)*T-e.h;e.vy=0;e.og=1}}
else{if(solid(e.x+3,e.y)||solid(e.x+e.w-3,e.y)){e.y=Math.ceil(e.y/T)*T;e.vy=0}}
if(isWind(e.x+e.w/2,e.y+e.h/2)){e.vy-=.8;if(e.vy<-4)e.vy=-4}
return e.y>SH*T+150;
}

// ======================================
//   ÊèèÁîªÈñ¢Êï∞
// ======================================
function drawBG(){
  let zone=getZone(camX+W/2);
  let g=X.createLinearGradient(0,0,0,H);
  if(zone===0){g.addColorStop(0,'#061830');g.addColorStop(.4,'#0e3870');g.addColorStop(1,'#2868a8')}
  else if(zone===1){g.addColorStop(0,'#040e28');g.addColorStop(.4,'#102850');g.addColorStop(1,'#1e4478')}
  else if(zone===2){g.addColorStop(0,'#0e0e30');g.addColorStop(.4,'#1e1e58');g.addColorStop(1,'#303078')}
  else if(zone===3){g.addColorStop(0,'#140820');g.addColorStop(.4,'#201040');g.addColorStop(1,'#301a58')}
  else{g.addColorStop(0,'#200808');g.addColorStop(.4,'#381010');g.addColorStop(1,'#481818')}
  X.fillStyle=g;X.fillRect(0,0,W,H);
  stars.forEach(s=>{
    let sx=(s.x-camX*s.spd*.03)%3000;if(sx<0)sx+=3000;
    if(sx>W+20)return;
    let bright=.4+Math.sin(frame*.03+s.tw)*.35;
    X.globalAlpha=bright;X.fillStyle=s.col;
    X.beginPath();X.arc(sx,s.y,s.sz,0,Math.PI*2);X.fill();
    if(s.sz>1.5){X.globalAlpha=bright*.3;X.beginPath();X.arc(sx,s.y,s.sz*2.5,0,Math.PI*2);X.fill()}
  });
  X.globalAlpha=1;
  for(let layer=0;layer<3;layer++){
    let speed=[.04,.08,.14][layer];let alpha=[.03,.05,.07][layer];
    let yOff=[30,80,150][layer];let cloudW=[120,90,60][layer];
    for(let i=0;i<15;i++){
      let cx=((i*210+layer*80+50)%1400)-(camX*speed%1400)+(frame*(layer+1)*.08);
      if(cx>1400)cx-=1400;if(cx<-200)cx+=1400;
      let cy=yOff+(i*73%100)+Math.sin(frame*.01+i+layer)*8;
      X.fillStyle=`rgba(180,200,230,${alpha+Math.sin(i+layer)*.015})`;
      X.beginPath();X.ellipse(cx,cy,cloudW+(i*17%40),12+layer*4+(i%8),0,0,Math.PI*2);X.fill();
    }
  }
  for(let i=0;i<14;i++){
    let bx=i*170-(camX*.1%(14*170));if(bx<-170)bx+=14*170;
    let bh=40+(i*61%100);let bw=70+(i*23%50);
    let bG=X.createLinearGradient(bx,H-bh-20,bx,H);
    bG.addColorStop(0,'rgba(15,25,50,.45)');bG.addColorStop(1,'rgba(10,15,30,.55)');
    X.fillStyle=bG;X.fillRect(bx,H-bh-20,bw,bh+20);
    for(let wy=8;wy<bh-5;wy+=12)for(let wx=6;wx<bw-6;wx+=14){
      if((i+wy+wx)%5<2){let wBright=.08+Math.sin(frame*.02+i+wy+wx)*.04;
        X.fillStyle=`rgba(255,220,100,${wBright})`;X.fillRect(bx+wx,H-bh-20+wy,4,4);}}
    if(i%3===0){X.fillStyle='rgba(20,30,50,.5)';X.fillRect(bx+bw/2-1,H-bh-35,2,15);
      let blink=(frame+i*30)%80<5?.6:.08;
      X.fillStyle=`rgba(255,50,50,${blink})`;X.beginPath();X.arc(bx+bw/2,H-bh-36,2,0,Math.PI*2);X.fill()}
  }
  if(zone===1){for(let i=0;i<6;i++){let wx=(frame*2.5+i*160)%W;let wy=50+(i*80)%H;
    X.strokeStyle=`rgba(180,220,255,${.12+Math.sin(frame*.04+i)*.06})`;X.lineWidth=1;
    X.beginPath();X.moveTo(wx,wy);X.lineTo(wx+50+Math.sin(frame*.08+i)*15,wy+3);X.stroke();}}
  if(zone===4&&boss.active){
    if(lightningTimer<=0&&Math.random()<.008){lightningTimer=4;lightningAlpha=.3+Math.random()*.2}
    if(lightningTimer>0){lightningTimer--;
      X.fillStyle=`rgba(200,220,255,${lightningAlpha*lightningTimer/4})`;X.fillRect(0,0,W,H);}
  }
}

function drawTile(tx,ty,t,sx,sy){
  if(t===0)return;
  let zone=getZone(tx*T);
  let above=ty>0?map[tx][ty-1]:99;
  let isTop=above===0||above===9||above===17||above===3||above===18||above===11;
  if(t===1||t===14||t===15||t===16){
    let colA,colB,colC;
    if(t===1){colA=isTop?'#5a9050':'#3a6028';colB=isTop?'#4a7a38':'#2a4a18';colC='#6aaa60'}
    else if(t===14){colA=isTop?'#6a7e90':'#4a5e6e';colB=isTop?'#5a6e80':'#3a4e5e';colC='#7a90a0'}
    else if(t===15){colA=isTop?'#7a78b0':'#4a487a';colB=isTop?'#6a68a0':'#3a386a';colC='#8a88c0'}
    else{colA=isTop?'#6a5890':'#4a3868';colB=isTop?'#5a487a':'#3a2858';colC='#7a68a0'}
    let tG=X.createLinearGradient(sx,sy,sx,sy+T);
    tG.addColorStop(0,colA);tG.addColorStop(1,colB);
    X.fillStyle=tG;X.fillRect(sx,sy,T,T);
    if(isTop){X.fillStyle=colC;X.fillRect(sx,sy,T,3);
      X.fillStyle='rgba(255,255,255,.1)';X.fillRect(sx,sy,T,1);
      if(t===1){for(let gx=0;gx<T;gx+=4){let gh=2+Math.sin(gx+tx*5)*.8;
        X.fillStyle='rgba(100,180,80,.3)';X.fillRect(sx+gx,sy-gh,2,gh)}}}
    let rnd=(tx*7321+ty*1301)%100;
    if(rnd<25){X.strokeStyle='rgba(0,0,0,.1)';X.lineWidth=.5;
      X.beginPath();X.moveTo(sx+rnd%T,sy+rnd%8);X.lineTo(sx+rnd%T+8,sy+rnd%8+12);X.stroke()}
    X.strokeStyle='rgba(0,0,0,.06)';X.strokeRect(sx,sy,T,T);
  }else if(t===2){
    let c1=zone===0?'#509850':zone===1?'#608898':zone===2?'#7060a8':zone===3?'#6050a0':'#888';
    let c2=zone===0?'#60a860':zone===1?'#70a0b0':zone===2?'#8070b8':zone===3?'#7060b0':'#999';
    let pG=X.createLinearGradient(sx,sy,sx,sy+T);
    pG.addColorStop(0,c2);pG.addColorStop(.2,c1);pG.addColorStop(1,c1);
    X.fillStyle=pG;X.fillRect(sx,sy,T,T);
    X.fillStyle='rgba(255,255,255,.12)';X.fillRect(sx+1,sy+1,T-2,2);
    X.strokeStyle='rgba(0,0,0,.1)';X.strokeRect(sx,sy,T,T);
  }else if(t===3){
    for(let i=0;i<4;i++){
      X.fillStyle='#bb1818';X.beginPath();X.moveTo(sx+i*8,sy+T);X.lineTo(sx+i*8+4,sy+3);X.lineTo(sx+i*8+8,sy+T);X.fill();
      X.fillStyle='#ee4444';X.beginPath();X.moveTo(sx+i*8+1,sy+T);X.lineTo(sx+i*8+4,sy+7);X.lineTo(sx+i*8+7,sy+T);X.fill();
      X.fillStyle='rgba(255,200,200,.2)';X.beginPath();X.moveTo(sx+i*8+2,sy+T);X.lineTo(sx+i*8+4,sy+11);X.lineTo(sx+i*8+6,sy+T);X.fill();
    }
  }else if(t===9){
    X.fillStyle='#7a6a4a';X.fillRect(sx+4,sy,5,T);X.fillRect(sx+T-9,sy,5,T);
    X.fillStyle='#9a8a6a';for(let r=2;r<T;r+=7)X.fillRect(sx+4,sy+r,T-8,3);
    X.fillStyle='rgba(255,255,255,.06)';X.fillRect(sx+5,sy,2,T);
  }else if(t===11){
    if(doorState===1){
      let openAmt=Math.min(1,doorAnimTimer/20);let dH=T*(1-openAmt);
      if(dH>2){X.fillStyle='#8a6600';X.fillRect(sx,sy,T,dH);
        X.fillStyle=`rgba(255,200,0,${.4+Math.sin(frame*.08)*.15})`;X.fillRect(sx+3,sy+2,T-6,dH-4)}
    }else if(doorState===2){
      let dG=X.createLinearGradient(sx,sy,sx+T,sy+T);
      dG.addColorStop(0,'#5a3300');dG.addColorStop(1,'#3a2200');
      X.fillStyle=dG;X.fillRect(sx,sy,T,T);
      X.fillStyle='rgba(180,80,0,.4)';X.fillRect(sx+3,sy+2,T-6,T-4);
      X.fillStyle='#2a1100';X.fillRect(sx+T/2-4,sy+T/2-5,8,10);
      X.strokeStyle='#ff2020';X.lineWidth=2;
      X.beginPath();X.moveTo(sx+7,sy+7);X.lineTo(sx+T-7,sy+T-7);X.stroke();
      X.beginPath();X.moveTo(sx+T-7,sy+7);X.lineTo(sx+7,sy+T-7);X.stroke();
    }else{
      let pulse=.4+Math.sin(frame*.08)*.2;
      let dG=X.createLinearGradient(sx,sy,sx+T,sy);
      dG.addColorStop(0,'#8a6600');dG.addColorStop(1,'#6a4a00');
      X.fillStyle=dG;X.fillRect(sx,sy,T,T);
      X.fillStyle=`rgba(255,200,0,${pulse})`;X.fillRect(sx+3,sy+2,T-6,T-4);
      X.fillStyle='#664400';X.fillRect(sx+T/2-4,sy+T/2-5,8,10);
    }
  }else if(t===12||t===13){
    X.fillStyle=t===12?'#384858':'#404060';X.fillRect(sx,sy,T,T);
    let below=ty<SH-1?map[tx][ty+1]:0;
    if(below===0||below===9||below===17){
      X.fillStyle=t===12?'#485868':'#505070';X.fillRect(sx,sy+T-3,T,3);
      if((tx+ty)%3===0){X.fillStyle=t===12?'#586878':'#606080';
        X.beginPath();X.moveTo(sx+5,sy+T);X.lineTo(sx+T/2,sy+T+5);X.lineTo(sx+T-5,sy+T);X.fill()}
    }
  }else if(t===17){
    let a=.08+Math.sin(frame*.06+tx)*.04;
    X.fillStyle=`rgba(140,200,255,${a})`;X.fillRect(sx,sy,T,T);
    X.strokeStyle=`rgba(200,230,255,${.15+Math.sin(frame*.1+tx)*.08})`;X.lineWidth=1;
    for(let l=0;l<2;l++){let ay=sy+T*(l+1)/3+Math.sin(frame*.12+tx+l*2)*5;
      X.beginPath();X.moveTo(sx+4,ay+3);X.quadraticCurveTo(sx+T/2,ay-5,sx+T-4,ay+3);X.stroke()}
  }else if(t===18){
    let lit=P.x/T>tx;
    X.fillStyle='#555';X.fillRect(sx+12,sy+2,8,T-2);
    X.fillStyle=lit?'#4f4':'#a44';X.beginPath();X.arc(sx+16,sy+2,7,0,Math.PI*2);X.fill();
    if(lit){X.fillStyle=`rgba(80,255,80,${.15+Math.sin(frame*.1)*.08})`;X.beginPath();X.arc(sx+16,sy+2,14,0,Math.PI*2);X.fill()}
  }
}

function drawTiles(){
  let stx=Math.floor(camX/T)-1,etx=Math.ceil((camX+W)/T)+1;
  let sty=Math.floor(camY/T)-1,ety=Math.ceil((camY+H)/T)+1;
  for(let tx=stx;tx<=etx;tx++)for(let ty=sty;ty<=ety;ty++){
    if(tx<0||tx>=SW||ty<0||ty>=SH)continue;
    drawTile(tx,ty,map[tx][ty],tx*T-camX,ty*T-camY);
  }
}

function drawItems(){
  items.forEach(it=>{
    if(!it.alive)return;
    let ix=it.x-camX,iy=it.y-camY+Math.sin(frame*.06+it.bobOff)*4;
    if(ix<-30||ix>W+30)return;
    if(it.type==='eSmall'){
      let eG=X.createRadialGradient(ix+8,iy+8,0,ix+8,iy+8,8);
      eG.addColorStop(0,'#88ddff');eG.addColorStop(.5,'#44aaff');eG.addColorStop(1,'rgba(68,170,255,0)');
      X.fillStyle=eG;X.beginPath();X.arc(ix+8,iy+8,10,0,Math.PI*2);X.fill();
      X.fillStyle='#66ccff';X.beginPath();X.arc(ix+8,iy+8,5,0,Math.PI*2);X.fill();
      X.fillStyle='#ccf0ff';X.beginPath();X.arc(ix+7,iy+6,2,0,Math.PI*2);X.fill();
    }else if(it.type==='eLarge'){
      let eG=X.createRadialGradient(ix+8,iy+8,0,ix+8,iy+8,10);
      eG.addColorStop(0,'#ffcc88');eG.addColorStop(.5,'#ff8844');eG.addColorStop(1,'rgba(255,136,68,0)');
      X.fillStyle=eG;X.beginPath();X.arc(ix+8,iy+8,14,0,Math.PI*2);X.fill();
      X.fillStyle='#ff9955';X.beginPath();X.arc(ix+8,iy+8,7,0,Math.PI*2);X.fill();
      X.fillStyle='#ffe0bb';X.beginPath();X.arc(ix+6,iy+6,2.5,0,Math.PI*2);X.fill();
    }else if(it.type==='life'){
      X.fillStyle=`rgba(255,68,68,${.15+Math.sin(frame*.08)*.08})`;X.beginPath();X.arc(ix+8,iy+8,14,0,Math.PI*2);X.fill();
      X.fillStyle='#ff3333';let cx2=ix+8,cy2=iy+8;
      X.beginPath();X.moveTo(cx2,cy2+4);X.bezierCurveTo(cx2-7,cy2-4,cx2-7,cy2-9,cx2,cy2-4);
      X.bezierCurveTo(cx2+7,cy2-9,cx2+7,cy2-4,cx2,cy2+4);X.fill();
      X.fillStyle='rgba(255,180,180,.4)';X.beginPath();X.arc(cx2-2,cy2-3,2,0,Math.PI*2);X.fill();
    }
  });
}

function drawPlayer(){
  if(P.dead)return;
  if(P.teleportIn>0){
    let ty2=P.y-camY-(P.teleportIn/60)*H;
    let tG=X.createLinearGradient(P.x-camX+8,ty2,P.x-camX+14,ty2+P.teleportIn*3);
    tG.addColorStop(0,'rgba(68,136,255,.2)');tG.addColorStop(.5,'#4488ff');tG.addColorStop(1,'rgba(68,136,255,.2)');
    X.fillStyle=tG;X.fillRect(P.x-camX+6,ty2,10,P.teleportIn*3);
    for(let i=0;i<4;i++)sparkle(P.x+11+Math.random()*6-3,P.y-P.teleportIn*5+Math.random()*30,'#88ccff');
    return;
  }
  if(P.inv>0&&Math.floor(P.inv/2)%2)return;
  let px=P.x-camX,py=P.y-camY,f=P.face;
  if(P.sliding){
    P.dashTrail.push({x:P.x,y:P.y,a:.35});
    if(P.dashTrail.length>8)P.dashTrail.shift();
    P.dashTrail.forEach((dt,i)=>{
      let ra=dt.a*(i/P.dashTrail.length);
      X.globalAlpha=ra;X.fillStyle='#3366cc';X.fillRect(dt.x-camX+2,dt.y-camY+18,18,12);
      X.globalAlpha=1;dt.a*=.82;
    });
  }else P.dashTrail=[];
  X.save();X.translate(px+P.w/2,py+P.h/2);if(f<0)X.scale(-1,1);
  let ox=-P.w/2,oy=-P.h/2;
  if(P.sliding){
    let sG=X.createLinearGradient(0,oy+16,0,oy+30);
    sG.addColorStop(0,'#3388ff');sG.addColorStop(1,'#2060cc');
    X.fillStyle=sG;X.beginPath();X.roundRect(ox-4,oy+18,28,12,5);X.fill();
    X.fillStyle='#3388ff';X.beginPath();X.arc(ox+2,oy+20,10,0,Math.PI*2);X.fill();
    X.fillStyle='#55aaff';X.beginPath();X.arc(ox+2,oy+17,3.5,0,Math.PI*2);X.fill();
    X.fillStyle='#ffe0b0';X.beginPath();X.roundRect(ox+4,oy+19,8,7,2);X.fill();
    X.fillStyle='#224';X.fillRect(ox+9,oy+21,2,2);
    for(let i=0;i<2;i++)if(frame%3===0)sparkle(P.x-P.face*5+Math.random()*6,P.y+P.h-2,'rgba(200,220,255,.4)');
    X.restore();return;
  }
  X.fillStyle='rgba(0,0,0,.18)';X.beginPath();X.ellipse(0,P.h/2+2,11,3.5,0,0,Math.PI*2);X.fill();
  let la=P.og&&Math.abs(P.vx)>.5?Math.sin(P.runFrame)*6:0;
  X.fillStyle='#1a55bb';
  X.fillRect(ox+3,oy+22,8,10+la);X.fillRect(ox+11,oy+22,8,10-la);
  let bootG=X.createLinearGradient(0,oy+28,0,oy+34);
  bootG.addColorStop(0,'#1144aa');bootG.addColorStop(1,'#0d3388');
  X.fillStyle=bootG;
  X.beginPath();X.roundRect(ox+1,oy+28+Math.max(0,la),10,6,2);X.fill();
  X.beginPath();X.roundRect(ox+10,oy+28-Math.min(0,la),10,6,2);X.fill();
  let bodyG=X.createLinearGradient(ox+2,oy+8,ox+20,oy+24);
  bodyG.addColorStop(0,'#3890ff');bodyG.addColorStop(1,'#2060cc');
  X.fillStyle=bodyG;X.beginPath();X.roundRect(ox+2,oy+10,18,14,4);X.fill();
  X.fillStyle='rgba(255,255,255,.1)';X.fillRect(ox+4,oy+11,5,4);
  if(P.chargeTimer>30){
    let cLv=P.chargeTimer>60?2:1;
    let ca=.15+Math.sin(frame*.35)*.12;
    let cc=cLv===2?`rgba(0,255,200,${ca})`:`rgba(100,200,255,${ca})`;
    X.fillStyle=cc;X.beginPath();X.arc(0,0,16+Math.sin(frame*.5)*3,0,Math.PI*2);X.fill();
    if(cLv===2){X.strokeStyle=`rgba(0,255,200,${.3+Math.sin(frame*.4)*.15})`;X.lineWidth=1.5;
      for(let r=0;r<3;r++){X.beginPath();X.arc(0,0,10+r*5+Math.sin(frame*.3+r)*2,
        frame*.1+r*2,frame*.1+r*2+Math.PI*1.2);X.stroke()}}
  }
  let helG=X.createRadialGradient(ox+11,oy+3,0,ox+11,oy+6,14);
  helG.addColorStop(0,'#58b0ff');helG.addColorStop(.7,'#2870dd');helG.addColorStop(1,'#1855bb');
  X.fillStyle=helG;X.beginPath();X.arc(0,oy+10,12,Math.PI,0);X.fill();
  X.fillRect(ox,oy+5,P.w,6);
  let earG=X.createRadialGradient(ox+P.w+1,oy+10,0,ox+P.w+1,oy+10,5);
  earG.addColorStop(0,'#2266dd');earG.addColorStop(1,'#1050bb');
  X.fillStyle=earG;X.beginPath();X.arc(ox+P.w+1,oy+10,5,0,Math.PI*2);X.fill();
  let gemG=X.createRadialGradient(-1,oy+2,0,0,oy+3,4.5);
  gemG.addColorStop(0,'#ccf8ff');gemG.addColorStop(.4,'#66ddff');gemG.addColorStop(1,'#2299dd');
  X.fillStyle=gemG;X.beginPath();X.arc(0,oy+3,4,0,Math.PI*2);X.fill();
  X.fillStyle='rgba(255,255,255,.7)';X.beginPath();X.arc(-1.5,oy+1.5,1.2,0,Math.PI*2);X.fill();
  let fG=X.createRadialGradient(ox+11,oy+14,0,ox+11,oy+14,8);
  fG.addColorStop(0,'#ffe8c0');fG.addColorStop(1,'#ddb888');
  X.fillStyle=fG;X.beginPath();X.roundRect(ox+4,oy+10,14,12,3);X.fill();
  X.fillStyle='#224';X.beginPath();X.ellipse(ox+14,oy+14,2.2,2.8,0,0,Math.PI*2);X.fill();
  X.fillStyle='#fff';X.beginPath();X.arc(ox+14.8,oy+13,1,0,Math.PI*2);X.fill();
  X.fillStyle='#cc8866';X.fillRect(ox+10,oy+18,4,1.5);
  X.fillStyle='#3388ff';
  if(P.st>0){
    X.fillRect(ox+16,oy+13,11,7);
    let bG=X.createRadialGradient(ox+27,oy+16.5,0,ox+27,oy+16.5,6);
    bG.addColorStop(0,'#90d0ff');bG.addColorStop(.5,'#3388ff');bG.addColorStop(1,'#2060cc');
    X.fillStyle=bG;X.beginPath();X.arc(ox+27,oy+16.5,6,0,Math.PI*2);X.fill();
    if(P.chargeTimer>30){X.fillStyle=`rgba(100,255,255,${.2+Math.sin(frame*.6)*.15})`;
      X.beginPath();X.arc(ox+27,oy+16.5,9,0,Math.PI*2);X.fill()}
    X.fillStyle='rgba(200,230,255,.25)';X.beginPath();X.arc(ox+30,oy+16.5,3,0,Math.PI*2);X.fill();
  }else{
    X.fillRect(ox+16,oy+14,8,6);
    let aG=X.createRadialGradient(ox+24,oy+17,0,ox+24,oy+17,5);
    aG.addColorStop(0,'#60aaff');aG.addColorStop(1,'#2266cc');
    X.fillStyle=aG;X.beginPath();X.arc(ox+24,oy+17,4.5,0,Math.PI*2);X.fill();
  }
  X.restore();
}

function drawEnemy(e){
  if(!e.alive)return;
  let ex=e.x-camX,ey=e.y-camY;
  if(ex<-60||ex>W+60)return;
  if(e.flash>0){X.globalAlpha=.5+Math.sin(frame)*.3;e.flash--}
  if(e.type==='goblin'){
    let bob=Math.sin(frame*.15)*2.5;
    let gG=X.createRadialGradient(ex+12,ey+12+bob,0,ex+12,ey+12+bob,14);
    gG.addColorStop(0,'#66dd66');gG.addColorStop(1,'#338833');
    X.fillStyle=gG;X.beginPath();X.roundRect(ex+1,ey+1+bob,22,20,6);X.fill();
    let eyeGlow=.8+Math.sin(frame*.12)*.2;
    X.fillStyle=`rgba(255,50,50,${eyeGlow})`;
    X.beginPath();X.arc(ex+7,ey+10+bob,3,0,Math.PI*2);X.fill();
    X.beginPath();X.arc(ex+17,ey+10+bob,3,0,Math.PI*2);X.fill();
    X.fillStyle='#ff8888';X.beginPath();X.arc(ex+7,ey+9+bob,1.2,0,Math.PI*2);X.fill();
    X.beginPath();X.arc(ex+17,ey+9+bob,1.2,0,Math.PI*2);X.fill();
    let la2=Math.sin(frame*.22)*3;
    X.fillStyle='#338833';
    X.fillRect(ex+4,ey+20+bob,6,8+la2);X.fillRect(ex+14,ey+20+bob,6,8-la2);
    X.fillStyle='#228822';
    X.beginPath();X.moveTo(ex+6,ey+2+bob);X.lineTo(ex+3,ey-6+bob);X.lineTo(ex+10,ey+2+bob);X.fill();
    X.beginPath();X.moveTo(ex+14,ey+2+bob);X.lineTo(ex+21,ey-6+bob);X.lineTo(ex+18,ey+2+bob);X.fill();
  }else if(e.type==='fly'){
    let fy=e.baseY+Math.sin(frame*.05+e.x*.008)*25-camY;
    e.y=e.baseY+Math.sin(frame*.05+e.x*.008)*25;
    let wing=Math.sin(frame*.35)*10;
    X.fillStyle='rgba(100,200,255,.25)';
    X.beginPath();X.ellipse(ex+12,fy+4,15+wing,6,-.3,0,Math.PI*2);X.fill();
    X.beginPath();X.ellipse(ex+12,fy+4,15+wing,6,.3,0,Math.PI*2);X.fill();
    X.strokeStyle='rgba(150,220,255,.3)';X.lineWidth=1;
    X.beginPath();X.ellipse(ex+12,fy+4,15+wing,6,-.3,0,Math.PI*2);X.stroke();
    X.beginPath();X.ellipse(ex+12,fy+4,15+wing,6,.3,0,Math.PI*2);X.stroke();
    let fG=X.createRadialGradient(ex+12,fy+13,0,ex+12,fy+13,10);
    fG.addColorStop(0,'#55aadd');fG.addColorStop(1,'#336699');
    X.fillStyle=fG;X.beginPath();X.arc(ex+12,fy+13,9,0,Math.PI*2);X.fill();
    X.fillStyle='#ff2222';X.beginPath();X.arc(ex+8,fy+11,2.5,0,Math.PI*2);X.fill();
    X.beginPath();X.arc(ex+16,fy+11,2.5,0,Math.PI*2);X.fill();
    X.fillStyle='#ff8888';X.beginPath();X.arc(ex+8,fy+10,1,0,Math.PI*2);X.fill();
    X.beginPath();X.arc(ex+16,fy+10,1,0,Math.PI*2);X.fill();
    X.fillStyle=`rgba(255,100,50,${.2+Math.sin(frame*.2)*.1})`;X.beginPath();X.arc(ex+12,fy+20,4,0,Math.PI*2);X.fill();
  }else if(e.type==='cannon'){
    let cG=X.createLinearGradient(ex,ey+4,ex+24,ey+24);
    cG.addColorStop(0,'#666');cG.addColorStop(1,'#444');
    X.fillStyle=cG;X.beginPath();X.roundRect(ex-1,ey+5,26,20,4);X.fill();
    X.fillStyle='#777';X.fillRect(ex+2,ey+8,20,14);
    let ang=Math.atan2(P.y-e.y,P.x-e.x);
    X.save();X.translate(ex+12,ey+15);X.rotate(ang);
    let bG=X.createLinearGradient(0,-4,0,4);
    bG.addColorStop(0,'#555');bG.addColorStop(1,'#333');
    X.fillStyle=bG;X.fillRect(0,-4,20,8);
    X.fillStyle='#fa0';X.beginPath();X.arc(20,0,4,0,Math.PI*2);X.fill();
    X.fillStyle=`rgba(255,170,0,${.3+Math.sin(frame*.15)*.15})`;X.beginPath();X.arc(20,0,7,0,Math.PI*2);X.fill();
    X.restore();
    X.strokeStyle=`rgba(255,0,0,${.15+Math.sin(frame*.1)*.08})`;X.lineWidth=.5;
    X.beginPath();X.moveTo(ex+12,ey+15);
    X.lineTo(ex+12+Math.cos(ang)*80,ey+15+Math.sin(ang)*80);X.stroke();
    let fl=.3+Math.sin(frame*.12)*.25;
    X.fillStyle=`rgba(255,0,0,${fl})`;X.beginPath();X.arc(ex+12,ey+5,3.5,0,Math.PI*2);X.fill();
  }else if(e.type==='shield'){
    let sG=X.createRadialGradient(ex+12,ey+12,0,ex+12,ey+12,14);
    sG.addColorStop(0,'#33aa55');sG.addColorStop(1,'#1a6633');
    X.fillStyle=sG;X.beginPath();X.roundRect(ex+1,ey+1,22,24,4);X.fill();
    X.fillStyle='#ff0';X.beginPath();X.arc(ex+12,ey+10,2.5,0,Math.PI*2);X.fill();
    X.fillStyle='#ffa';X.beginPath();X.arc(ex+12,ey+9,1,0,Math.PI*2);X.fill();
    let sd=e.dir<0?-8:20;
    let shG=X.createLinearGradient(ex+sd,ey-2,ex+sd+10,ey+28);
    shG.addColorStop(0,'rgba(80,255,140,.5)');shG.addColorStop(.5,'rgba(40,200,100,.7)');shG.addColorStop(1,'rgba(80,255,140,.5)');
    X.fillStyle=shG;X.beginPath();X.roundRect(ex+sd,ey-2,10,28,4);X.fill();
    X.strokeStyle=`rgba(100,255,150,${.3+Math.sin(frame*.15)*.15})`;X.lineWidth=1;
    X.beginPath();X.roundRect(ex+sd-2,ey-4,14,32,5);X.stroke();
  }
  X.globalAlpha=1;
}

function drawAirMan(){
  if(!boss.alive&&!boss.defeated)return;
  if(!boss.active)return;
  if(!boss.visible)return;
  if(boss.inv>0&&Math.floor(boss.inv/2)%2)return;
  let bx=boss.x-camX,by=boss.y-camY;
  let aurR=boss.phase>=2?55:boss.phase>=1?48:42;
  let aurA=.08+Math.sin(frame*.07)*.04;
  if(boss.phase>=2){
    X.fillStyle=`rgba(255,40,20,${aurA+.06})`;X.beginPath();X.arc(bx+24,by+28,aurR+Math.sin(frame*.12)*6,0,Math.PI*2);X.fill();
    X.strokeStyle=`rgba(255,100,50,${.15+Math.sin(frame*.1)*.08})`;X.lineWidth=2;
    X.beginPath();X.arc(bx+24,by+28,aurR+8,frame*.05,frame*.05+Math.PI*1.5);X.stroke();
  }else if(boss.phase>=1){
    X.fillStyle=`rgba(100,180,255,${aurA+.04})`;X.beginPath();X.arc(bx+24,by+28,aurR+Math.sin(frame*.1)*4,0,Math.PI*2);X.fill();
  }else{
    X.fillStyle=`rgba(80,150,230,${aurA})`;X.beginPath();X.arc(bx+24,by+28,aurR,0,Math.PI*2);X.fill();
  }
  X.save();
  let la=boss.og?Math.sin(frame*.15)*4:0;
  let legG=X.createLinearGradient(bx+8,by+44,bx+8,by+60);
  legG.addColorStop(0,'#2255aa');legG.addColorStop(1,'#1844aa');
  X.fillStyle=legG;
  X.fillRect(bx+8,by+44,14,14+la);X.fillRect(bx+26,by+44,14,14-la);
  let bootG2=X.createLinearGradient(bx,by+54,bx,by+62);
  bootG2.addColorStop(0,'#1a44aa');bootG2.addColorStop(1,'#0e3090');
  X.fillStyle=bootG2;
  X.beginPath();X.roundRect(bx+5,by+54+Math.max(0,la),18,7,3);X.fill();
  X.beginPath();X.roundRect(bx+23,by+54-Math.min(0,la),18,7,3);X.fill();
  let bdG=X.createLinearGradient(bx,by+14,bx+48,by+46);
  bdG.addColorStop(0,'#3890ee');bdG.addColorStop(.5,'#2870cc');bdG.addColorStop(1,'#2060bb');
  X.fillStyle=bdG;X.beginPath();X.roundRect(bx+4,by+16,40,30,6);X.fill();
  X.fillStyle='rgba(255,255,255,.08)';X.fillRect(bx+8,by+18,15,6);
  boss.fanAngle+=(boss.at>0?.35:.1);
  X.save();X.translate(bx+24,by+32);X.rotate(boss.fanAngle);
  for(let i=0;i<6;i++){
    X.save();X.rotate(i*Math.PI/3);
    let bladeG=X.createLinearGradient(-3,-14,3,0);
    bladeG.addColorStop(0,'#bbb');bladeG.addColorStop(.5,'#888');bladeG.addColorStop(1,'#666');
    X.fillStyle=bladeG;
    X.beginPath();X.moveTo(-3,-2);X.lineTo(-1,-14);X.lineTo(1,-14);X.lineTo(3,-2);X.fill();
    X.strokeStyle='rgba(255,255,255,.15)';X.lineWidth=.5;X.beginPath();X.moveTo(0,-2);X.lineTo(0,-13);X.stroke();
    X.restore();
  }
  X.restore();
  let cnG=X.createRadialGradient(bx+24,by+32,0,bx+24,by+32,6);
  cnG.addColorStop(0,'#777');cnG.addColorStop(1,'#444');
  X.fillStyle=cnG;X.beginPath();X.arc(bx+24,by+32,6,0,Math.PI*2);X.fill();
  X.strokeStyle=`rgba(160,180,200,${.5+Math.sin(frame*.08)*.15})`;X.lineWidth=2.5;
  X.beginPath();X.arc(bx+24,by+32,13,0,Math.PI*2);X.stroke();
  if(boss.at>0){X.strokeStyle=`rgba(200,230,255,${.3})`;X.lineWidth=1;
    X.beginPath();X.arc(bx+24,by+32,17,0,Math.PI*2);X.stroke()}
  let armG=X.createLinearGradient(bx-6,by+18,bx-6,by+42);
  armG.addColorStop(0,'#2870cc');armG.addColorStop(1,'#1e5caa');
  X.fillStyle=armG;
  X.beginPath();X.roundRect(bx-8,by+18,16,24,5);X.fill();
  X.beginPath();X.roundRect(bx+40,by+18,16,24,5);X.fill();
  let fistG=X.createRadialGradient(bx+0,by+43,0,bx+0,by+43,7);
  fistG.addColorStop(0,'#3888dd');fistG.addColorStop(1,'#2060bb');
  X.fillStyle=fistG;X.beginPath();X.arc(bx+0,by+43,7,0,Math.PI*2);X.fill();
  X.beginPath();X.arc(bx+48,by+43,7,0,Math.PI*2);X.fill();
  X.fillStyle='rgba(0,0,0,.15)';
  for(let v=0;v<3;v++){X.fillRect(bx-4,by+22+v*6,8,2);X.fillRect(bx+44,by+22+v*6,8,2)}
  let hG=X.createRadialGradient(bx+24,by+5,0,bx+24,by+10,20);
  hG.addColorStop(0,'#58b0ff');hG.addColorStop(.6,'#2870dd');hG.addColorStop(1,'#1a5cbb');
  X.fillStyle=hG;X.beginPath();X.arc(bx+24,by+10,19,0,Math.PI*2);X.fill();
  X.fillStyle='#fff';
  X.beginPath();X.ellipse(bx+15,by+8,5.5,6.5,-.1,0,Math.PI*2);X.fill();
  X.beginPath();X.ellipse(bx+33,by+8,5.5,6.5,.1,0,Math.PI*2);X.fill();
  let eyeCol=boss.phase>=2?'#ff1111':boss.phase>=1?'#ff6600':'#111';
  X.fillStyle=eyeCol;
  X.beginPath();X.ellipse(bx+16,by+9,3.5,4.5,0,0,Math.PI*2);X.fill();
  X.beginPath();X.ellipse(bx+32,by+9,3.5,4.5,0,0,Math.PI*2);X.fill();
  let pupilCol=boss.phase>=1?'#ffaa00':'#f22';
  X.fillStyle=pupilCol;X.beginPath();X.arc(bx+16,by+8,1.5,0,Math.PI*2);X.fill();
  X.beginPath();X.arc(bx+32,by+8,1.5,0,Math.PI*2);X.fill();
  if(boss.phase>=1){
    let eg=boss.phase>=2?'rgba(255,50,0,.2)':'rgba(255,100,0,.12)';
    X.fillStyle=eg;X.beginPath();X.arc(bx+16,by+9,8,0,Math.PI*2);X.fill();
    X.beginPath();X.arc(bx+32,by+9,8,0,Math.PI*2);X.fill();
  }
  X.strokeStyle='#114';X.lineWidth=3;
  X.beginPath();X.moveTo(bx+8,by+2);X.lineTo(bx+19,by+5);X.stroke();
  X.beginPath();X.moveTo(bx+40,by+2);X.lineTo(bx+29,by+5);X.stroke();
  let mOpen=boss.at>0?7:boss.mouthOpen;
  X.fillStyle='#111';X.beginPath();X.ellipse(bx+24,by+18,9,mOpen,0,0,Math.PI*2);X.fill();
  X.fillStyle='#eee';
  for(let i=0;i<5;i++){X.fillRect(bx+13+i*5,by+18-mOpen+1,3.5,3)}
  for(let i=0;i<5;i++){X.fillRect(bx+13+i*5,by+18+mOpen-4,3.5,3)}
  if(boss.at>0){X.fillStyle=`rgba(100,200,255,${.2+Math.sin(frame*.3)*.1})`;
    X.beginPath();X.ellipse(bx+24,by+18,6,mOpen-2,0,0,Math.PI*2);X.fill()}
  let crG=X.createLinearGradient(bx+24,by-18,bx+24,by);
  crG.addColorStop(0,'#55bbff');crG.addColorStop(1,'#2870dd');
  X.fillStyle=crG;
  X.beginPath();X.moveTo(bx+24,by-18);X.lineTo(bx+17,by);X.lineTo(bx+31,by);X.fill();
  X.fillStyle='#66ccff';
  X.beginPath();X.moveTo(bx+24,by-14);X.lineTo(bx+19,by);X.lineTo(bx+29,by);X.fill();
  X.fillStyle=boss.phase>=2?'#ff4444':'#aaeeff';
  X.beginPath();X.arc(bx+24,by-6,3,0,Math.PI*2);X.fill();
  X.fillStyle='rgba(255,255,255,.5)';X.beginPath();X.arc(bx+23,by-7,1,0,Math.PI*2);X.fill();
  if(boss.phase>=2){
    for(let i=0;i<4;i++){
      let fx=bx+10+Math.random()*28,fya=by+Math.random()*56;
      X.fillStyle=`rgba(255,${80+Math.random()*80},0,${.1+Math.random()*.08})`;
      X.beginPath();X.arc(fx,fya,3+Math.random()*4,0,Math.PI*2);X.fill();
    }
  }
  if(boss.slamState===1){
    X.fillStyle=`rgba(255,255,100,${.15+Math.sin(frame*.5)*.1})`;
    X.beginPath();X.arc(bx+24,by+56,20,0,Math.PI*2);X.fill();
  }
  X.restore();
}

function drawBullets(){
  pBul.forEach(b=>{
    let bx=b.x-camX,by=b.y-camY;
    let sz=b.charged?12:8;
    let bG=X.createRadialGradient(bx+4,by+4,0,bx+4,by+4,sz);
    if(b.charged){bG.addColorStop(0,'#fff');bG.addColorStop(.2,'#80ffdd');bG.addColorStop(.6,'#00cc88');bG.addColorStop(1,'rgba(0,200,150,0)')}
    else{bG.addColorStop(0,'#fff');bG.addColorStop(.25,'#ffff66');bG.addColorStop(.6,'#ffaa00');bG.addColorStop(1,'rgba(255,200,0,0)')}
    X.fillStyle=bG;X.beginPath();X.arc(bx+4,by+4,sz,0,Math.PI*2);X.fill();
    X.fillStyle=b.charged?'#ccffee':'#fff';X.beginPath();X.arc(bx+4,by+4,b.charged?5:3,0,Math.PI*2);X.fill();
    if(b.charged){X.fillStyle='rgba(0,255,180,.15)';
      X.beginPath();X.ellipse(bx+4-b.vx*.5,by+4,8,3,Math.atan2(0,b.vx),0,Math.PI*2);X.fill()}
  });
  eBul.forEach(b=>{
    let bx=b.x-camX,by=b.y-camY;
    if(b.tornado){
      X.save();X.translate(bx+6,by+6);X.rotate(frame*.18);
      let tSz=b.big?1.6:1;
      for(let i=0;i<3;i++){
        let a=.4+Math.sin(frame*.15+i)*.15;
        X.fillStyle=`rgba(140,200,255,${a})`;X.save();X.rotate(i*Math.PI*2/3);
        X.beginPath();X.ellipse(0,0,12*tSz,4*tSz,0,0,Math.PI*2);X.fill();X.restore();
      }
      X.fillStyle='#ddeeff';X.beginPath();X.arc(0,0,3*tSz,0,Math.PI*2);X.fill();
      X.restore();
    }else if(b.shockwave){
      X.fillStyle=`rgba(255,200,50,${.5+Math.sin(frame*.2)*.2})`;
      X.beginPath();X.arc(bx+4,by+4,6,0,Math.PI*2);X.fill();
      X.strokeStyle='rgba(255,220,100,.3)';X.lineWidth=2;X.beginPath();X.arc(bx+4,by+4,10,0,Math.PI*2);X.stroke();
    }else{
      let eG=X.createRadialGradient(bx+4,by+4,0,bx+4,by+4,8);
      eG.addColorStop(0,'#fff');eG.addColorStop(.3,'#ff4488');eG.addColorStop(1,'rgba(255,0,80,0)');
      X.fillStyle=eG;X.beginPath();X.arc(bx+4,by+4,8,0,Math.PI*2);X.fill();
    }
  });
}

function drawParts(){
  parts.forEach(p=>{
    X.globalAlpha=Math.min(1,p.life/12);
    if(p.type===1){
      X.fillStyle=p.col;X.beginPath();
      X.moveTo(p.x-camX,p.y-camY-p.sz*1.3);
      X.lineTo(p.x-camX+p.sz*.6,p.y-camY);
      X.lineTo(p.x-camX,p.y-camY+p.sz*1.3);
      X.lineTo(p.x-camX-p.sz*.6,p.y-camY);X.fill();
    }else{
      X.fillStyle=p.col;X.beginPath();X.arc(p.x-camX,p.y-camY,p.sz,0,Math.PI*2);X.fill();
      if(p.sz>3){X.fillStyle='rgba(255,255,255,.3)';X.beginPath();X.arc(p.x-camX-p.sz*.2,p.y-camY-p.sz*.2,p.sz*.3,0,Math.PI*2);X.fill()}
    }
  });X.globalAlpha=1;
}

function drawFloatTexts(){
  floatTexts.forEach(ft=>{
    X.globalAlpha=Math.min(1,ft.life/18);
    X.fillStyle=ft.col;X.font='bold 13px "Courier New",monospace';X.textAlign='center';
    X.shadowColor=ft.col;X.shadowBlur=6;
    X.fillText(ft.text,ft.x-camX,ft.y-camY);
    X.shadowBlur=0;
  });X.globalAlpha=1;
}

function drawWindParts(){
  windParticles.forEach(wp=>{
    X.globalAlpha=wp.life/30;
    X.fillStyle='rgba(200,230,255,.45)';X.beginPath();X.arc(wp.x-camX,wp.y-camY,wp.sz,0,Math.PI*2);X.fill();
    X.strokeStyle='rgba(200,230,255,.2)';X.lineWidth=1;
    X.beginPath();X.moveTo(wp.x-camX,wp.y-camY);X.lineTo(wp.x-camX-wp.vx*2,wp.y-camY-wp.vy*2);X.stroke();
  });X.globalAlpha=1;
}

function drawVignette(){
  let vG=X.createRadialGradient(W/2,H/2,Math.min(W,H)*.3,W/2,H/2,Math.max(W,H)*.8);
  vG.addColorStop(0,'rgba(0,0,0,0)');vG.addColorStop(1,'rgba(0,0,0,.35)');
  X.fillStyle=vG;X.fillRect(0,0,W,H);
}

function drawBossWarning(){
  if(bossIntro>0){
    let a=bossIntro>150?.85:bossIntro/150*.65;
    X.fillStyle=`rgba(0,0,0,${a})`;X.fillRect(0,0,W,H);
    if(bossIntro<=150&&bossIntro>50){
      if(bossIntro>120){
        let wa=((150-bossIntro)/30);
        X.fillStyle=`rgba(255,0,0,${wa*.15})`;X.fillRect(0,0,W,H);
        X.fillStyle=`rgba(255,50,50,${wa})`;X.font=`bold ${28+Math.sin(frame*.3)*3}px "Courier New",monospace`;
        X.textAlign='center';X.shadowColor='#f00';X.shadowBlur=25;
        X.fillText('‚ö† WARNING ‚ö†',W/2,H/2-30);X.shadowBlur=0;
      }
      if(bossIntro<=120){
        X.fillStyle='#fff';X.font='bold 32px "Courier New",monospace';X.textAlign='center';
        X.shadowColor='#4488ff';X.shadowBlur=25;
        X.fillText('AIR MAN',W/2,H/2-10);
        X.font='14px "Courier New",monospace';X.fillStyle='#99bbdd';
        X.fillText('‚Äî MASTER OF WIND ‚Äî',W/2,H/2+18);
        if(bossIntro<100){
          let barProg=(100-bossIntro)/50;barProg=Math.min(1,barProg);
          X.fillStyle='rgba(40,40,40,.8)';X.fillRect(W/2-80,H/2+40,160,12);
          X.fillStyle='#dd3333';X.fillRect(W/2-78,H/2+42,156*barProg,8);
        }
        X.shadowBlur=0;
      }
    }
  }
}

// ===== ÂâçÂçä„Åì„Åì„Åæ„Åß =====
// ===== ÂæåÂçä„Å´Á∂ö„Åè =====

// ===== ÂæåÂçäÈñãÂßã =====

// ======================================
//   „Éó„É¨„Ç§„É§„ÉºÊõ¥Êñ∞
// ======================================
function updPlayer(){
  if(P.dead)return;
  if(P.teleportIn>0){P.teleportIn--;return}

  P.vx=0;
  if(boss.suctionActive&&boss.active&&!P.dead){
    let sDir=boss.x+24>P.x+11?1:-1;
    P.vx+=sDir*3;
  }

  if(P.sliding){
    P.vx=SPD*2.1*P.face;P.slideTimer--;
    if(P.slideTimer<=0||(!P.og&&!P.climbing)){P.sliding=0;P.h=30;P.y-=12}
  }else{
    if(K.l){P.vx+=-SPD;P.face=-1}
    if(K.r){P.vx+=SPD;P.face=1}
  }

  let onLad=isLad(P.x+P.w/2,P.y+P.h/2)||isLad(P.x+P.w/2,P.y+P.h);
  if(onLad&&K.u){P.climbing=1;P.vy=-3;P.og=0}
  else if(P.climbing&&!onLad)P.climbing=0;
  if(P.climbing){P.vy=K.u?-3:(K.l||K.r?0:1);if(P.og)P.climbing=0}

  if(K.j&&P.og&&!P.climbing&&!P.sliding){P.vy=JF;P.og=0}

  if(slPress&&P.og&&!P.sliding&&!P.climbing){
    P.sliding=1;P.slideTimer=18;P.h=18;P.y+=12;slPress=0;
    boom(P.x,P.y+P.h,'rgba(200,210,255,.4)',5);
  }
  slPress=0;

  if(K.s){P.chargeTimer++;
    if(P.chargeTimer===30){sparkle(P.x+11,P.y+5,'#88eeff');sparkle(P.x+11,P.y+5,'#aaf')}
    if(P.chargeTimer===60){sparkle(P.x+11,P.y+5,'#00ffcc');sparkle(P.x+11,P.y+5,'#0fc')}
    if(P.chargeTimer>30&&frame%4===0)sparkle(P.x+11+Math.random()*8-4,P.y+Math.random()*20,
      P.chargeTimer>60?'#0fc':'#8ef');
  }else if(P.chargeTimer>0){
    if(pBul.length<5){
      let charged=P.chargeTimer>=60?2:P.chargeTimer>=30?1:0;
      pBul.push({x:P.x+(P.face>0?P.w:-8),y:P.y+(P.sliding?4:10),
        vx:BSPD*P.face*(charged?1.35:1),w:8,h:8,life:55,dmg:charged===2?4:charged===1?2:1,charged:charged>0});
      P.st=charged?12:8;
      if(charged){boom(P.x+(P.face>0?P.w+4:-4),P.y+12,charged===2?'#0fc':'#8ef',charged*4);
        camShake=charged===2?3:1}
    }
    P.chargeTimer=0;
  }

  if(sPress&&P.st<=0&&pBul.length<5&&P.chargeTimer<5){
    pBul.push({x:P.x+(P.face>0?P.w:-8),y:P.y+(P.sliding?4:10),vx:BSPD*P.face,w:8,h:8,life:55,dmg:1,charged:0});
    P.st=8;sPress=0;
  }
  if(P.st>0)P.st--;

  let wasOg=P.og;
  if(moveEnt(P))P.hp=0;
  if(!wasOg&&P.og&&P.vy===0){
    P.landDust=6;
    for(let i=0;i<4;i++)parts.push({x:P.x+P.w/2+(Math.random()-.5)*16,y:P.y+P.h,
      vx:(Math.random()-.5)*3,vy:-Math.random()*1.5,life:12+Math.random()*8,col:'rgba(200,210,220,.4)',sz:1+Math.random()*2,type:0});
  }
  if(P.landDust>0)P.landDust--;

  let tc=tileAt(P.x+P.w/2,P.y+P.h-2);
  if(tc===3){dmgP(4);P.vy=-6}

  let cpTile=Math.floor(P.x/T);
  [55,110,170].forEach(cp=>{if(cpTile>=cp&&checkpoint<cp){checkpoint=cp;
    addFloatText(P.x,P.y-20,'‚úì CHECKPOINT!','#4f4');screenFlash=8;
    for(let i=0;i<8;i++)sparkle(P.x+Math.random()*20-10,P.y+Math.random()*20-10,'#4f4')}});

  let playerTileX=Math.floor(P.x/T);
  if(playerTileX>=218&&playerTileX<DOOR_X&&doorState===0){
    doorState=1;doorAnimTimer=0;screenFlash=12;
    addFloatText(DOOR_X*T,12*T,'üö™ DOOR OPEN!','#ff0');boom(DOOR_X*T+16,12*T,'#ff0',15);
  }
  if(doorState===1)doorAnimTimer++;
  if(playerTileX>DOOR_X&&doorState===1){
    doorState=2;screenFlash=8;camShake=6;
    addFloatText(DOOR_X*T,12*T,'üîí LOCKED!','#f44');boom(DOOR_X*T+16,12*T,'#f44',12);
  }

  items.forEach(it=>{
    if(!it.alive)return;
    if(Math.abs(P.x-it.x)<20&&Math.abs(P.y-it.y)<20){
      it.alive=0;
      if(it.type==='eSmall'){P.hp=Math.min(P.mhp,P.hp+4);addFloatText(it.x,it.y-10,'+4 HP','#4af');score+=100}
      else if(it.type==='eLarge'){P.hp=Math.min(P.mhp,P.hp+10);addFloatText(it.x,it.y-10,'+10 HP','#f84');score+=200}
      else if(it.type==='life'){lives++;addFloatText(it.x,it.y-10,'1UP!','#f44');score+=500}
      boom(it.x,it.y,'#fff',10);
      for(let i=0;i<5;i++)sparkle(it.x+Math.random()*10-5,it.y+Math.random()*10-5,
        it.type==='life'?'#f88':'#8cf');
    }
  });

  if(P.x<0)P.x=0;if(P.inv>0)P.inv--;
  if(P.hp<=0&&!P.dead){
    P.dead=1;boom(P.x+11,P.y+15,'#4488ff',28);camShake=12;screenFlash=15;
    for(let i=0;i<12;i++)sparkle(P.x+11+Math.random()*10-5,P.y+15+Math.random()*10-5,'#88ccff');
    lives--;
    setTimeout(()=>{
      if(lives<=0){over=1;showOvl('üíÄ GAME OVER','SCORE: '+score,'RETRY','CONTINUE?')}
      else{respawn()}
    },1500);
  }
  document.getElementById('php').style.width=(P.hp/P.mhp*100)+'%';
  if(P.hp/P.mhp<.3)document.getElementById('php').style.background='linear-gradient(90deg,#d22,#f66)';
  else if(P.hp/P.mhp<.6)document.getElementById('php').style.background='linear-gradient(90deg,#da2,#fd6)';
  else document.getElementById('php').style.background='linear-gradient(90deg,#2d2,#6f6)';
  if(Math.abs(P.vx)>.5&&P.og)P.runFrame+=.25;

  if(comboTimer>0){comboTimer--;if(comboTimer<=0){combo=0;document.getElementById('comboDisp').style.display='none'}}

  document.getElementById('scoreDisp').textContent='SCORE: '+score;
  document.getElementById('lifeDisp').textContent='LIFE: '+'‚òÖ'.repeat(Math.max(0,lives))+'‚òÜ'.repeat(Math.max(0,3-lives));
  document.getElementById('weaponDisp').textContent=P.chargeTimer>60?'WEAPON: ‚òÖ FULL CHARGE ‚òÖ':P.chargeTimer>30?'WEAPON: CHARGING..':'WEAPON: P.BUSTER';
}

function respawn(){
  if(doorState===2){P.x=(DOOR_X+2)*T;P.y=14*T;
    if(boss.alive){boss.timer=0;boss.patTimer=0;boss.patPhase=0;
      boss.megaTornadoes=[];boss.suctionActive=0;boss.visible=1;boss.inv=60;eBul=[];}
  }else{P.x=checkpoint*T+60;P.y=300}
  P.vx=0;P.vy=0;P.hp=P.mhp;P.dead=0;P.inv=90;P.teleportIn=40;
  P.sliding=0;P.h=30;P.chargeTimer=0;P.climbing=0;pBul=[];eBul=[];
}

function dmgP(d){
  if(P.inv>0||P.dead||P.teleportIn>0)return;
  P.hp-=d;P.inv=50;P.vx=-P.face*4;P.vy=-4;
  boom(P.x+11,P.y+12,'#fff',10);camShake=5;
  combo=0;comboTimer=0;document.getElementById('comboDisp').style.display='none';
}

function dropItem(x,y){
  let r=Math.random();
  if(r<.22){
    items.push({x,y,w:16,h:16,type:'eSmall',alive:1,bobOff:Math.random()*6.28});
    sparkle(x,y,'#4af');
  }else if(r<.30){
    items.push({x,y,w:16,h:16,type:'eLarge',alive:1,bobOff:Math.random()*6.28});
    sparkle(x,y,'#f84');
  }else if(r<.34){
    items.push({x,y,w:16,h:16,type:'life',alive:1,bobOff:Math.random()*6.28});
    sparkle(x,y,'#f44');
  }
}

function addCombo(x,y,pts){
  combo++;comboTimer=120;
  if(combo>maxCombo)maxCombo=combo;
  let bonus=combo>=10?5:combo>=5?3:combo>=3?2:1;
  let total=pts*bonus;score+=total;
  if(combo>=3){
    addFloatText(x,y-25,combo+'x COMBO!','#f84');
    document.getElementById('comboDisp').style.display='block';
    document.getElementById('comboDisp').textContent='COMBO: '+combo+'x';
  }
}

// ======================================
//   Âºæ‰∏∏Êõ¥Êñ∞
// ======================================
function updBul(){
  pBul=pBul.filter(b=>{b.x+=b.vx;b.life--;
    if(solid(b.x+4,b.y+4)){boom(b.x,b.y,b.charged?'#0fc':'#ff4',b.charged?10:5);return false}return b.life>0});
  eBul=eBul.filter(b=>{b.x+=b.vx;b.y+=(b.vy||0);b.life--;
    if(b.gravity)b.vy+=.15;
    if(solid(b.x+4,b.y+4)){if(b.shockwave)boom(b.x,b.y,'#fa0',6);return false}
    if(!P.dead&&P.teleportIn<=0&&rCol(b,P)){dmgP(b.dmg||2);boom(b.x,b.y,'#f88',6);return false}
    return b.life>0;
  });
}

// ======================================
//   „Ç∂„Ç≥ÊïµÊõ¥Êñ∞
// ======================================
function updEnemies(){
  enemies.forEach(e=>{
    if(!e.alive)return;
    let dist=Math.abs(e.x-P.x);if(dist>W*1.3)return;
    e.timer++;

    if(e.type==='goblin'){
      e.vx=1.5*e.dir;if(e.timer%180===0)e.dir*=-1;
      if(e.timer%80===0&&dist<300)e.vy=-8;
      moveEnt(e);
    }else if(e.type==='fly'){
      e.dir=P.x<e.x?-1:1;
      if(e.timer%50===0&&dist<380)
        eBul.push({x:e.x+12,y:e.y+12,vx:4*e.dir,vy:1.5,w:8,h:8,life:50,dmg:2});
    }else if(e.type==='cannon'){
      if(e.timer%28===0&&dist<420){
        let a=Math.atan2(P.y-e.y,P.x-e.x);
        eBul.push({x:e.x+12,y:e.y+15,vx:Math.cos(a)*5.5,vy:Math.sin(a)*5.5,w:8,h:8,life:50,dmg:2});
        e.flash=6;
      }
      moveEnt(e);
    }else if(e.type==='shield'){
      e.dir=P.x<e.x?-1:1;e.vx=1*e.dir;
      if(e.timer%60===0&&dist<400)
        eBul.push({x:e.x+12,y:e.y+10,vx:5*e.dir,vy:0,w:8,h:8,life:55,dmg:2});
      moveEnt(e);
    }

    pBul.forEach((b,bi)=>{
      if(!e.alive)return;
      if(rCol(b,e)){
        if(e.type==='shield'){
          let hitSS=(b.vx>0&&e.dir<0)||(b.vx<0&&e.dir>0);
          if(hitSS){b.vx*=-1;boom(b.x,b.y,'#4a8',5);return}
        }
        e.hp-=b.dmg||1;pBul.splice(bi,1);boom(b.x,b.y,'#ff4',7);e.flash=4;
        if(e.hp<=0){
          e.alive=0;boom(e.x+12,e.y+14,'#f80',20);
          let pts=e.type==='cannon'?400:e.type==='shield'?300:200;
          addFloatText(e.x,e.y-10,'+'+pts,'#ff0');
          addCombo(e.x,e.y,pts);
          dropItem(e.x+4,e.y+4);
        }
      }
    });
    if(!P.dead&&e.alive&&P.teleportIn<=0&&rCol(e,P)){
      if(P.sliding&&e.type==='goblin'){
        e.alive=0;boom(e.x+12,e.y+14,'#f80',14);
        addFloatText(e.x,e.y-10,'SLIDE!','#0ff');addCombo(e.x,e.y,200);
        dropItem(e.x+4,e.y+4);
      }else dmgP(2);
    }
  });
}

// ======================================
//   „Éú„ÇπÊõ¥Êñ∞
// ======================================
function chooseBossPattern(){
  let avail=[];
  if(boss.phase===0)avail=[0,1,2,3,4];
  else if(boss.phase===1)avail=[0,1,2,3,4,5,6,7];
  else avail=[0,1,2,3,4,5,6,7,8,9];
  avail=avail.filter(p=>p!==boss.lastPat);
  let pick=avail[Math.floor(Math.random()*avail.length)];
  boss.lastPat=pick;
  return pick;
}

function bossBaseMovement(scale){
  let spd=(2.5+boss.phase*1.2)*scale;
  let dx=P.x-(boss.x+24);
  if(Math.abs(dx)>25)boss.vx+=(dx>0?1:-1)*spd*.14;
  let maxSpd=spd*1.5;
  if(boss.vx>maxSpd)boss.vx=maxSpd;
  if(boss.vx<-maxSpd)boss.vx=-maxSpd;
  boss.vx*=.92;
  if(boss.og&&Math.random()<(.018+boss.phase*.012))
    boss.vy=-9-Math.random()*5-boss.phase*2;
}

function updBoss(){
  if(!boss.alive&&!boss.defeated)return;

  if(boss.defeated){
    boss.defeatTimer++;
    if(boss.defeatTimer%10===0)boom(boss.x+Math.random()*48,boss.y+Math.random()*56,
      ['#ff0','#f80','#f44','#fff','#4af','#0f0'][Math.floor(Math.random()*6)],18);
    if(boss.defeatTimer%15===0)sparkle(boss.x+24+Math.random()*30-15,boss.y+Math.random()*50,'#fff');
    if(boss.defeatTimer%6===0)camShake=Math.min(10,boss.defeatTimer/20);
    if(boss.defeatTimer>200&&!clear){
      clear=1;screenFlash=35;score+=5000;
      clearGame();
      showOvl('üéâ STAGE CLEAR! üéâ',
        'üîÆ È≠Ç„ÅÆÊúÄÁµÇÁ´†„ÇØ„É™„Ç¢ÔºÅ<br>AIR MAN DEFEATED!<br>SCORE: '+score+'<br>MAX COMBO: '+maxCombo+'x<br><br>‚ú® ÊúÄÂæå„ÅÆ„Éí„É≥„ÉàÊñáÂ≠ó„ÇíÁç≤Âæó„Åó„Åæ„Åó„Åü ‚ú®',
        'MENU','‚Üê „É°„Éã„É•„Éº„Å´Êàª„Çã');
    }
    return;
  }

  if(!boss.active&&doorState===2){
    boss.active=1;bossIntro=200;boss.x=7600;boss.y=300;boss.hp=boss.mhp;
    document.getElementById('bhud').style.display='block';
    screenFlash=20;
  }
  if(!boss.active)return;

  if(bossIntro>0){
    bossIntro--;
    if(bossIntro===170)zoneLabel='‚ö† WARNING ‚ö†';
    if(bossIntro===120){zoneLabel='AIR MAN';zoneLT=140}
    if(bossIntro===60)screenFlash=12;
    if(bossIntro>120){boss.y=300-(bossIntro-120)*3;
      for(let i=0;i<3;i++)sparkle(boss.x+24+Math.random()*12-6,boss.y+Math.random()*56,'#88ccff');}
    if(bossIntro===1){boss.pat=chooseBossPattern();boss.patTimer=0;boss.patPhase=0;boss.patCount=0}
    return;
  }

  let oldPhase=boss.phase;
  boss.phase=boss.hp<boss.mhp*.3?2:boss.hp<boss.mhp*.6?1:0;
  if(boss.phase!==oldPhase){
    boss.phaseTransition=1;boss.phaseTransTimer=50;
    screenFlash=18;camShake=10;
    boom(boss.x+24,boss.y+28,boss.phase>=2?'#f44':'#4af',25);
    addFloatText(boss.x+24,boss.y-20,boss.phase>=2?'‚ö° FURY MODE ‚ö°':'üí® WIND SURGE üí®',
      boss.phase>=2?'#f44':'#4af');
    for(let i=0;i<15;i++)sparkle(boss.x+Math.random()*48,boss.y+Math.random()*56,
      boss.phase>=2?'#f84':'#8cf');
  }
  if(boss.phaseTransition){
    boss.phaseTransTimer--;
    if(boss.phaseTransTimer<=0)boss.phaseTransition=0;
    boss.inv=Math.max(boss.inv,2);
    bossBaseMovement(.5);moveEnt(boss);
    if(boss.x<7100)boss.x=7100;if(boss.x>8200)boss.x=8200;
    return;
  }

  boss.timer++;boss.patTimer++;
  boss.dir=P.x<boss.x?-1:1;
  boss.mouthOpen=3;
  boss.suctionActive=0;

  let patDone=false;

  switch(boss.pat){

  case 0:{
    let dur=boss.phase>=2?80:boss.phase>=1?100:120;
    bossBaseMovement(1.0);
    if(boss.patTimer===1&&boss.og)boss.vy=-12-boss.phase*3;
    let fireInt=boss.phase>=2?10:boss.phase>=1?15:22;
    if(boss.patTimer%fireInt===0&&boss.patTimer>5){
      let numT=4+boss.phase*2;
      for(let i=0;i<numT;i++){
        let angle=-Math.PI/2.5+i*(Math.PI*2/2.5)/(numT-1);
        if(boss.dir<0)angle=Math.PI-angle;
        let sp=4.5+boss.phase*1.2;
        eBul.push({x:boss.x+24,y:boss.y+32,vx:Math.cos(angle)*sp,
          vy:Math.sin(angle)*sp-2,w:12,h:12,life:85,tornado:1,dmg:3});
      }
      boss.at=15;boss.mouthOpen=7;
      for(let i=0;i<5;i++)windParticles.push({x:boss.x+24,y:boss.y+32,
        vx:(Math.random()-.5)*10+boss.dir*4,vy:(Math.random()-.5)*8-3,life:30,sz:2+Math.random()*3});
    }
    if(boss.patTimer>=dur)patDone=true;
    break;
  }

  case 1:{
    if(boss.patPhase===0){
      bossBaseMovement(.3);
      if(boss.patTimer>12){boss.patPhase=1;boss.patTimer=0;
        boss.dashSpeed=10+boss.phase*4;
        addFloatText(boss.x+24,boss.y-10,'üí®','#ff0');camShake=4;}
    }else if(boss.patPhase===1){
      boss.vx=boss.dashSpeed*boss.dir;
      if(boss.patTimer%3===0)windParticles.push({x:boss.x+24,y:boss.y+28,
        vx:-boss.dir*5+Math.random()*2,vy:(Math.random()-.5)*3,life:15,sz:3});
      if(boss.patTimer%6===0)
        eBul.push({x:boss.x+24,y:boss.y+50,vx:(Math.random()-.5)*3,vy:2,w:10,h:10,life:45,shockwave:1,dmg:2,gravity:0});
      if(boss.patTimer%10===0&&boss.phase>=1)
        eBul.push({x:boss.x+24,y:boss.y+20,vx:-boss.dir*3,vy:-4,w:12,h:12,life:60,tornado:1,dmg:2});
      if(boss.patTimer>30||solid(boss.x+boss.w+5,boss.y+30)||solid(boss.x-5,boss.y+30)){
        boss.patPhase=2;boss.patTimer=0;boss.vx=0;
        boom(boss.x+24,boss.y+28,'#ff8',14);camShake=8;
        for(let i=-4;i<=4;i++)
          eBul.push({x:boss.x+24,y:boss.y+50,vx:i*2.8,vy:-3.5,w:10,h:10,life:50,shockwave:1,dmg:3,gravity:1});
      }
    }else{
      bossBaseMovement(.6);
      if(boss.patTimer>18){
        if(boss.patCount<(boss.phase>=2?3:boss.phase>=1?2:1)){
          boss.patPhase=0;boss.patTimer=0;boss.patCount++}
        else patDone=true;
      }
    }
    break;
  }

  case 2:{
    if(boss.patPhase===0){
      if(boss.patTimer===1){boss.vy=-20-boss.phase*3;boss.vx=(P.x-boss.x)*.05;
        addFloatText(boss.x+24,boss.y-10,'‚Üë‚Üë','#f84')}
      boss.vx+=(P.x-boss.x)*.008;
      if(boss.patTimer>18&&boss.vy>=0){boss.patPhase=1;boss.patTimer=0;boss.slamState=1}
    }else if(boss.patPhase===1){
      boss.vy=16+boss.phase*4;boss.vx=(P.x-boss.x)*.06;boss.slamState=1;
      if(boss.og){
        boss.patPhase=2;boss.patTimer=0;boss.slamState=0;
        camShake=14;screenFlash=10;
        boom(boss.x+24,boss.y+56,'#fa0',22);boom(boss.x+24,boss.y+56,'#ff0',18);
        for(let side=-1;side<=1;side+=2)
          for(let i=1;i<=6+boss.phase*2;i++)
            eBul.push({x:boss.x+24+side*i*4,y:boss.y+50,vx:side*(3.5+i*.6),vy:-4.5-Math.random()*3,
              w:10,h:10,life:55,shockwave:1,dmg:3,gravity:1});
        if(boss.phase>=1)
          for(let i=0;i<4+boss.phase*2;i++){
            let a=Math.random()*Math.PI*2;
            eBul.push({x:boss.x+24,y:boss.y+40,vx:Math.cos(a)*5.5,vy:-5-Math.random()*3,
              w:12,h:12,life:65,tornado:1,dmg:3});}
      }
    }else{
      bossBaseMovement(.8);
      if(boss.patTimer>20){
        if(boss.patCount<(boss.phase>=1?1:0)){boss.patPhase=0;boss.patTimer=0;boss.patCount++}
        else patDone=true;
      }
    }
    break;
  }

  case 3:{
    if(boss.patPhase===0){
      bossBaseMovement(.3);boss.suctionActive=1;boss.mouthOpen=8;
      if(boss.patTimer%4===0)
        windParticles.push({x:P.x+Math.random()*50-25,y:P.y+Math.random()*40-20,
          vx:(boss.x+24-P.x)*.07,vy:(boss.y+28-P.y)*.07,life:20,sz:2+Math.random()*2});
      if(boss.patTimer%8===0)addFloatText(boss.x+24,boss.y+10,'üí®','rgba(150,200,255,.6)');
      if(boss.patTimer>=40+boss.phase*10){boss.patPhase=1;boss.patTimer=0;boss.suctionActive=0}
    }else{
      if(boss.patTimer===1){
        boss.mouthOpen=10;boss.at=20;camShake=10;screenFlash=8;
        let numB=10+boss.phase*5;
        for(let i=0;i<numB;i++){
          let a=i*(Math.PI*2/numB)+Math.random()*.2;
          let sp=5.5+boss.phase*1.5;
          eBul.push({x:boss.x+24,y:boss.y+28,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,
            w:12,h:12,life:70,tornado:1,dmg:3});}
        for(let i=0;i<22;i++)windParticles.push({x:boss.x+24,y:boss.y+28,
          vx:(Math.random()-.5)*16,vy:(Math.random()-.5)*16,life:25,sz:3+Math.random()*4});
        boom(boss.x+24,boss.y+28,'#8cf',28);
      }
      bossBaseMovement(.5);
      if(boss.patTimer>30)patDone=true;
    }
    break;
  }

  case 4:{
    bossBaseMovement(.8);
    if(boss.patTimer===1&&boss.og)boss.vy=-10-boss.phase*3;
    let sr=boss.phase>=2?3:boss.phase>=1?4:5;
    if(boss.patTimer%sr===0){
      let a=boss.patTimer*.22,sp=4.5+boss.phase*.8;
      eBul.push({x:boss.x+24,y:boss.y+28,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,
        w:12,h:12,life:75,tornado:1,dmg:2});
      if(boss.phase>=1){let a2=-boss.patTimer*.22+Math.PI;
        eBul.push({x:boss.x+24,y:boss.y+28,vx:Math.cos(a2)*sp,vy:Math.sin(a2)*sp,
          w:12,h:12,life:75,tornado:1,dmg:2});}
      if(boss.phase>=2){let a3=boss.patTimer*.22+Math.PI/2;
        eBul.push({x:boss.x+24,y:boss.y+28,vx:Math.cos(a3)*sp*.8,vy:Math.sin(a3)*sp*.8,
          w:12,h:12,life:75,tornado:1,dmg:2});}
      boss.at=5;
    }
    if(boss.patTimer>=75+boss.phase*15)patDone=true;
    break;
  }

  case 5:{
    if(boss.patPhase===0){
      if(boss.patTimer===10){
        boss.visible=0;boom(boss.x+24,boss.y+28,'#88f',18);
        let tpx=P.x+(Math.random()>.5?-70:70)+Math.random()*50-25;
        boss.teleportX=Math.max(7120,Math.min(8180,tpx));
        boss.teleportY=Math.max(250,P.y-40+Math.random()*30);
      }
      if(boss.patTimer>=25){boss.patPhase=1;boss.patTimer=0}
    }else{
      if(boss.patTimer===1){
        boss.x=boss.teleportX;boss.y=boss.teleportY;
        boss.visible=1;boss.dir=P.x<boss.x?-1:1;
        boom(boss.x+24,boss.y+28,'#f4f',20);screenFlash=6;camShake=5;
        addFloatText(boss.x+24,boss.y-15,'!!','#f00');
        let numA=6+boss.phase*3;
        for(let i=0;i<numA;i++){let a=i*(Math.PI*2/numA);
          eBul.push({x:boss.x+24,y:boss.y+28,vx:Math.cos(a)*5.5,vy:Math.sin(a)*5.5,
            w:12,h:12,life:60,tornado:1,dmg:3});}
        boss.vx=(P.x-boss.x)*.15;boss.vy=-5;
      }
      bossBaseMovement(1.2);
      if(boss.patTimer>22){
        if(boss.patCount<(boss.phase>=2?3:boss.phase>=1?2:1)){
          boss.patPhase=0;boss.patTimer=0;boss.patCount++;}
        else patDone=true;
      }
    }
    break;
  }

  case 6:{
    bossBaseMovement(1.0);
    if(boss.patTimer===1&&boss.og)boss.vy=-12;
    let wi=boss.phase>=2?7:boss.phase>=1?10:14;
    if(boss.patTimer%wi===0&&boss.patTimer>3){
      for(let i=0;i<5+boss.phase;i++)
        eBul.push({x:boss.x+24+boss.dir*50,y:boss.y-80+i*28,
          vx:boss.dir*(3+boss.phase*1.5),vy:(Math.random()-.5)*2,
          w:12,h:12,life:75,tornado:1,dmg:2});
      boss.at=10;
      for(let i=0;i<3;i++)windParticles.push({x:boss.x+24,y:boss.y+28,
        vx:boss.dir*12,vy:(Math.random()-.5)*5,life:25,sz:4});
    }
    if(boss.patTimer>=65+boss.phase*10)patDone=true;
    break;
  }

  case 7:{
    if(boss.patPhase===0){
      bossBaseMovement(.5);boss.mouthOpen=9;boss.at=25;
      if(boss.patTimer===1){camShake=6;addFloatText(boss.x+24,boss.y-15,'MEGA TORNADO!','#4ef');
        let num=2+boss.phase;
        for(let i=0;i<num;i++)
          boss.megaTornadoes.push({x:boss.x+24+i*30-30,y:boss.y+28,vx:boss.dir*3,vy:-3,
            life:130+boss.phase*40,sz:2,target:1});}
      if(boss.patTimer>15){boss.patPhase=1;boss.patTimer=0}
    }else{
      bossBaseMovement(1.2);
      if(boss.og&&boss.patTimer%35===0)boss.vy=-12-boss.phase*2;
      if(boss.patTimer%18===0){let a=Math.atan2(P.y-boss.y,P.x-boss.x);
        eBul.push({x:boss.x+24,y:boss.y+28,vx:Math.cos(a)*5,vy:Math.sin(a)*5,
          w:12,h:12,life:60,tornado:1,dmg:3});boss.at=8;}
      if(boss.patTimer>=90)patDone=true;
    }
    break;
  }

  case 8:{
    bossBaseMovement(1.0);
    if(boss.patTimer===1&&boss.og)boss.vy=-15;
    let br=boss.phase>=2?5:8;
    if(boss.patTimer%br===0){let a=Math.random()*Math.PI*2;
      eBul.push({x:boss.x+24,y:boss.y+28,vx:Math.cos(a)*6.5,vy:Math.sin(a)*6.5-2,
        w:10,h:10,life:100,tornado:1,dmg:2,bounce:4});boss.at=4;}
    if(boss.patTimer%20===0&&boss.phase>=1){let a=Math.atan2(P.y-boss.y,P.x-boss.x);
      eBul.push({x:boss.x+24,y:boss.y+28,vx:Math.cos(a)*6,vy:Math.sin(a)*6,
        w:12,h:12,life:60,tornado:1,dmg:3});}
    if(boss.patTimer>=75)patDone=true;
    break;
  }

  case 9:{
    if(boss.patPhase===0){
      if(boss.patTimer===1){boss.vy=-18;camShake=10;screenFlash=14;
        addFloatText(boss.x+24,boss.y-25,'‚ö° DESPERATION ‚ö°','#f22');
        boom(boss.x+24,boss.y+28,'#f44',35);}
      bossBaseMovement(.3);
      if(boss.patTimer>=22){boss.patPhase=1;boss.patTimer=0}
    }else if(boss.patPhase===1){
      boss.vy+=Math.sin(frame*.12)*1.5-.3;
      boss.vx+=(P.x-boss.x)*.02+Math.sin(frame*.07)*3;
      let mx=8;if(boss.vx>mx)boss.vx=mx;if(boss.vx<-mx)boss.vx=-mx;
      if(boss.patTimer%3===0){let nB=2+Math.floor(Math.random()*2);
        for(let i=0;i<nB;i++){let a=Math.random()*Math.PI*2,sp=4+Math.random()*3.5;
          eBul.push({x:boss.x+24,y:boss.y+28,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,
            w:12,h:12,life:70,tornado:1,dmg:3});}boss.at=3;}
      if(boss.patTimer%15===0)
        for(let s=-1;s<=1;s+=2)
          eBul.push({x:boss.x+24,y:boss.y+50,vx:s*6,vy:-2.5,w:10,h:10,life:55,shockwave:1,dmg:3,gravity:1});
      if(boss.patTimer%25===0){let a=Math.atan2(P.y-boss.y,P.x-boss.x);
        for(let i=-1;i<=1;i++)
          eBul.push({x:boss.x+24,y:boss.y+28,vx:Math.cos(a+i*.3)*6,vy:Math.sin(a+i*.3)*6,
            w:12,h:12,life:65,tornado:1,dmg:4,big:1});}
      if(boss.patTimer>=90){boss.patPhase=2;boss.patTimer=0}
    }else{bossBaseMovement(.5);if(boss.patTimer>25)patDone=true;}
    break;
  }
  }

  boss.megaTornadoes=boss.megaTornadoes.filter(mt=>{
    mt.life--;
    if(mt.target){let dx=P.x+11-mt.x,dy=P.y+15-mt.y,dist=Math.sqrt(dx*dx+dy*dy);
      if(dist>5){mt.vx+=(dx/dist)*.3;mt.vy+=(dy/dist)*.3}
      let mSpd=Math.sqrt(mt.vx*mt.vx+mt.vy*mt.vy),maxMs=5+boss.phase;
      if(mSpd>maxMs){mt.vx*=maxMs/mSpd;mt.vy*=maxMs/mSpd}}
    mt.x+=mt.vx;mt.y+=mt.vy;mt.sz=Math.min(mt.sz+.025,3.5);
    if(!P.dead&&P.teleportIn<=0){
      let mr={x:mt.x-15*mt.sz,y:mt.y-15*mt.sz,w:30*mt.sz,h:30*mt.sz};
      if(rCol(mr,P)){dmgP(4);mt.life=0}}
    return mt.life>0;
  });

  eBul.forEach(b=>{if(b.bounce&&b.bounce>0){
    if(b.y+(b.h||10)>SH*T-T*2||b.y<T*2){b.vy*=-.85;b.bounce--}
    if(b.x<7100||b.x>8250){b.vx*=-.85;b.bounce--}}});

  if(boss.at>0)boss.at--;
  if(boss.visible)moveEnt(boss);
  if(boss.x<7100)boss.x=7100;if(boss.x>8200)boss.x=8200;
  if(boss.inv>0)boss.inv--;

  if(patDone){
    boss.pat=chooseBossPattern();boss.patTimer=0;boss.patPhase=0;boss.patCount=0;
    boss.slamState=0;boss.suctionActive=0;boss.megaTornadoes=[];
    boss.patTimer=-(5-boss.phase*2);
  }

  pBul=pBul.filter(b=>{
    if(boss.visible&&rCol(b,boss)&&boss.inv<=0){
      boss.hp-=(b.dmg||1);boss.inv=15;boss.flash=8;
      boom(b.x,b.y,'#ff4',12);camShake=3;
      addFloatText(b.x,b.y-15,'-'+(b.dmg||1),'#ff0');score+=50*(b.dmg||1);
      if(boss.hp<=0){
        boss.alive=0;boss.defeated=1;boss.defeatTimer=0;boss.visible=1;
        screenFlash=30;camShake=18;score+=5000;
        boss.megaTornadoes=[];boss.suctionActive=0;eBul=[];
      }return false;
    }return true;
  });

  if(!P.dead&&boss.alive&&boss.visible&&P.teleportIn<=0&&rCol(boss,P))dmgP(4);

  let bhpPct=(Math.max(0,boss.hp)/boss.mhp*100);
  document.getElementById('bhp').style.width=bhpPct+'%';
  if(boss.phase>=2)document.getElementById('bhp').style.background='linear-gradient(90deg,#d11,#f44)';
  else if(boss.phase>=1)document.getElementById('bhp').style.background='linear-gradient(90deg,#d80,#fa4)';
  else document.getElementById('bhp').style.background='linear-gradient(90deg,#d33,#f77)';
}

// ======================================
//   „Éë„Éº„ÉÜ„Ç£„ÇØ„É´„Éª„Ç´„É°„É©‰ªñ
// ======================================
function updParts(){
  parts=parts.filter(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=.1;p.vx*=.97;p.life--;p.sz*=.99;return p.life>0&&p.sz>.2});
  floatTexts=floatTexts.filter(ft=>{ft.y+=ft.vy;ft.vy*=.98;ft.life--;return ft.life>0});
  windParticles=windParticles.filter(wp=>{wp.x+=wp.vx;wp.y+=wp.vy;wp.vy+=.04;wp.life--;return wp.life>0});
  let zone=getZone(P.x);
  if(frame%5===0){
    if(zone===1)sparkle(camX+Math.random()*W,camY+Math.random()*H,'rgba(180,220,255,.25)');
    if(zone===4&&boss.active)sparkle(camX+Math.random()*W,camY+Math.random()*H,
      boss.phase>=2?'rgba(255,80,60,.2)':'rgba(100,180,255,.2)');
  }
}

function updCam(){
  let tx=P.x-W/3,ty=P.y-H*.42;
  camX+=(tx-camX)*.09;camY+=(ty-camY)*.09;
  if(camX<0)camX=0;if(camX>SW*T-W)camX=Math.max(0,SW*T-W);
  if(camY>SH*T-H)camY=SH*T-H;if(camY<0)camY=0;
  if(camShake>0){camX+=Math.sin(frame*2.5)*camShake;camY+=Math.cos(frame*3.5)*camShake*.6;camShake=Math.max(0,camShake-.35)}
}

function checkZone(){
  let z=getZone(P.x);
  let names=['‚òÅ SKY GARDENS ‚òÅ','üí® WIND TUNNELS üí®','üè∞ CLOUD FORTRESS üè∞','üóº STORM TOWER üóº','‚ö° BOSS CHAMBER ‚ö°'];
  let n=names[z];if(n!==zoneLabel&&!bossIntro){zoneLabel=n;zoneLT=160}
}

function showOvl(t,sub,btnText,btnText2){
  let o=document.getElementById('overlay');o.style.display='flex';
  let isGameClear=clear===1;
  let btn1Action=isGameClear?'goBack()':'location.reload()';
  let btn1Label=isGameClear?'üè† „É°„Éã„É•„Éº„Å´Êàª„Çã':btnText;
  o.innerHTML=`<h1 style="color:#4af;text-shadow:0 0 30px #4af,0 0 60px #28f">${t}</h1>
  <p style="color:#ccc">${sub}</p>
  <button class="sbtn" onclick="${btn1Action}">${btn1Label}</button>`;
  if(!isGameClear){
    o.innerHTML+=`<button class="mbtn" onclick="goBack()">‚Üê „É°„Éã„É•„Éº„Å´Êàª„Çã</button>`;
  }
}

// ======================================
//   ËøΩÂä†ÊèèÁîªÈñ¢Êï∞
// ======================================
function drawMegaTornadoes(){
  boss.megaTornadoes.forEach(mt=>{
    let mx=mt.x-camX,my=mt.y-camY;
    X.save();X.translate(mx,my);X.rotate(frame*.2);let s=mt.sz;
    for(let r=0;r<4;r++){let a=.35-r*.06+Math.sin(frame*.15+r)*.1;
      X.fillStyle=`rgba(120,200,255,${a})`;
      X.beginPath();X.ellipse(0,r*3*s,14*s-r*2,6*s-r,frame*.1+r,0,Math.PI*2);X.fill();}
    X.fillStyle='rgba(220,240,255,.7)';X.beginPath();X.arc(0,0,4*s,0,Math.PI*2);X.fill();
    X.restore();
    X.fillStyle=`rgba(100,180,255,${.12+Math.sin(frame*.12)*.06})`;
    X.beginPath();X.arc(mx,my,22*s,0,Math.PI*2);X.fill();
  });
}

function drawSuctionEffect(){
  if(!boss.suctionActive)return;
  let bx=boss.x+24-camX,by=boss.y+28-camY,px2=P.x+11-camX,py2=P.y+15-camY;
  X.strokeStyle=`rgba(150,200,255,${.15+Math.sin(frame*.2)*.08})`;X.lineWidth=2;
  for(let i=0;i<6;i++){let t=((frame*3+i*40)%200)/200;
    let lx=px2+(bx-px2)*t,ly=py2+(by-py2)*t;
    X.beginPath();X.arc(lx,ly,3+Math.sin(frame*.3+i)*2,0,Math.PI*2);X.stroke();}
  for(let i=0;i<10;i++){let a=i*Math.PI/5+frame*.06,r=90+Math.sin(frame*.08+i)*25;
    X.globalAlpha=.08+Math.sin(frame*.1+i)*.04;
    X.beginPath();X.moveTo(bx+Math.cos(a)*r,by+Math.sin(a)*r);X.lineTo(bx,by);X.stroke();}
  X.globalAlpha=1;
}

function drawPause(){
  X.fillStyle='rgba(0,0,0,.7)';X.fillRect(0,0,W,H);
  X.fillStyle='#fff';X.font='bold 28px "Courier New",monospace';X.textAlign='center';
  X.shadowColor='#4af';X.shadowBlur=15;X.fillText('PAUSE',W/2,H/2-10);
  X.font='14px "Courier New",monospace';X.fillStyle='#aaa';X.shadowBlur=0;
  X.fillText('Press ESC to resume',W/2,H/2+20);
}

// ======================================
//   „É°„Ç§„É≥„É´„Éº„Éó
// ======================================
function loop(){
  requestAnimationFrame(loop);
  if(!started||over||clear)return;
  if(paused){drawPause();return}
  frame++;

  if(screenFadeIn>0)screenFadeIn--;
  else{updPlayer();updBul();updEnemies();updBoss();updParts();updCam();checkZone()}

  X.save();X.clearRect(0,0,W,H);
  drawBG();drawTiles();drawItems();drawParts();drawWindParts();
  enemies.forEach(e=>drawEnemy(e));
  drawAirMan();drawMegaTornadoes();drawSuctionEffect();
  drawPlayer();drawBullets();drawFloatTexts();drawVignette();

  if(zoneLT>0){zoneLT--;
    let a=zoneLT>140?((160-zoneLT)/20):zoneLT<30?(zoneLT/30):1;
    X.globalAlpha=a;X.fillStyle='#fff';
    X.font='bold clamp(14px,3vw,22px) "Courier New",monospace';X.textAlign='center';
    X.shadowColor='#000';X.shadowBlur=10;X.fillText(zoneLabel,W/2,52);X.shadowBlur=0;X.globalAlpha=1;}

  if(P.x/T>210&&P.x/T<218&&doorState===0){
    let a=.5+Math.sin(frame*.12)*.3;
    X.fillStyle=`rgba(255,200,50,${a})`;X.font='bold 18px monospace';X.textAlign='center';
    X.shadowColor='#f80';X.shadowBlur=10;X.fillText('‚Üí BOSS AHEAD ‚Üí',W/2,48);X.shadowBlur=0;}

  drawBossWarning();

  if(screenFlash>0){X.fillStyle=`rgba(255,255,255,${Math.min(.6,screenFlash/20)})`;X.fillRect(0,0,W,H);screenFlash--}
  if(screenFadeIn>0){X.fillStyle=`rgba(0,0,0,${screenFadeIn/60})`;X.fillRect(0,0,W,H)}

  if(boss.defeated){
    let da=Math.min(.4,boss.defeatTimer/200*.4)+Math.sin(frame*.18)*.08;
    X.fillStyle=`rgba(255,255,255,${da})`;X.fillRect(0,0,W,H);
    if(boss.defeatTimer>100){X.globalAlpha=Math.min(1,(boss.defeatTimer-100)/50);
      X.fillStyle='#ff0';X.font='bold 16px "Courier New",monospace';X.textAlign='center';
      X.shadowColor='#fa0';X.shadowBlur=10;X.fillText('VICTORY!',W/2,H/2-30);
      X.font='12px "Courier New",monospace';X.fillStyle='#fff';X.shadowBlur=0;
      X.fillText('SCORE: '+score,W/2,H/2);X.globalAlpha=1;}}

  if(boss.phaseTransition){let ta=boss.phaseTransTimer/60*.3;
    X.fillStyle=boss.phase>=2?`rgba(255,50,30,${ta})`:`rgba(50,150,255,${ta})`;X.fillRect(0,0,W,H);}

  if(P.hp>0&&P.hp<=P.mhp*.25&&!P.dead){let da=.08+Math.sin(frame*.15)*.05;
    let dG=X.createRadialGradient(W/2,H/2,Math.min(W,H)*.2,W/2,H/2,Math.max(W,H)*.7);
    dG.addColorStop(0,'rgba(0,0,0,0)');dG.addColorStop(1,`rgba(200,0,0,${da})`);
    X.fillStyle=dG;X.fillRect(0,0,W,H);}

  X.restore();
}

// ======================================
//   „Çπ„Çø„Éº„Éà
// ======================================
document.getElementById('startBtn').onclick=()=>{
  document.getElementById('overlay').style.display='none';
  started=1;zoneLT=160;zoneLabel='‚òÅ SKY GARDENS ‚òÅ';
};

loop();
</script>
</body>
</html>
